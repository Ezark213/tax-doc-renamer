# 📚 税務書類リネームシステム - アーカイブ版履歴 (v5.5.0以前)

このファイルは過去バージョンの詳細情報を保持しています。最新情報は [README.md](../README.md) を参照してください。

## 🚨 **重要：これが最新版v5.4.4-stableです**

### 📅 **最新更新情報（2025年9月16日）**
- **GitHubコミット**: `7520035` (ドキュメント), `42f42e7` (修正)
- **重大バグ**: 重複処理・20系番号 → **完全解決済み**
- **テスト状況**: **11テストケース全PASS**
- **安定性**: **Production Ready**

### 📚 **最新修正ドキュメント**
- **[重複処理・20系番号バグ修正 統合レポート](docs/CRITICAL_BUG_FIX_DuplicateProcessing_20240916_COMPREHENSIVE.md)** ⭐ **最新**
- **[Claude Code作業記録](CLAUDE.md)** - 本セッションの詳細ログ
- **[完全ドキュメント](docs/README.md)** - 全機能・修正履歴

### 🔄 **過去バージョンからの改善**
| バージョン | 主要改善点 | ステータス |
|-----------|-----------|----------|
| v5.4.4-stable | 重複処理・20系番号修正 | **✅ 最新** |
| v5.4.2 | Threading問題修正 | 継承済み |
| v5.3.5 | UI強制・JobContext | 継承済み |

## 📋 対応書類一覧（完全版）

| 分類 | 番号 | 書類名 | 例 |
|------|------|--------|-----|
| **国税** | 0000 | 納付税額一覧表 | `0000_納付税額一覧表_2508.pdf` |
| | 0001 | 法人税申告書 | `0001_法人税及び地方法人税申告書_2508.pdf` |
| | 0002 | 添付資料（法人税） | `0002_添付資料_法人税_2508.pdf` |
| | 0003 | 受信通知（法人税） | `0003_受信通知_2508.pdf` |
| | 0004 | 納付情報（法人税） | `0004_納付情報_2508.pdf` |
| **都道府県税** | 1001 | 都道府県税申告書（東京都） | `1001_東京都_法人都道府県民税・事業税・特別法人事業税_2508.pdf` |
| | 1011 | 都道府県税申告書（2番目） | `1011_愛知県_法人都道府県民税・事業税・特別法人事業税_2508.pdf` |
| | 1021 | 都道府県税申告書（3番目） | `1021_福岡県_法人都道府県民税・事業税・特別法人事業税_2508.pdf` |
| | 1003 | 受信通知（東京都固定） | `1003_受信通知_2508.pdf` |
| | 1013 | 受信通知（愛知県） | `1013_受信通知_2508.pdf` |
| | 1023 | 受信通知（福岡県） | `1023_受信通知_2508.pdf` |
| | 1004 | 納付情報（都道府県税） | `1004_納付情報_2508.pdf` |
| **市町村税** | 2001 | 市町村税申告書（蒲郡市） | `2001_愛知県蒲郡市_市町村申告書_2508.pdf` |
| | 2011 | 市町村税申告書（福岡市） | `2011_福岡県福岡市_市町村申告書_2508.pdf` |
| | 2003 | 受信通知（蒲郡市） | `2003_受信通知_2508.pdf` |
| | 2013 | 受信通知（福岡市） | `2013_受信通知_2508.pdf` |
| | 2004 | 納付情報（市町村税） | `2004_納付情報_2508.pdf` |
| **消費税** | 3001 | 消費税申告書 | `3001_消費税及び地方消費税申告書_2508.pdf` |
| | 3002 | 添付資料（消費税） | `3002_添付資料_消費税_2508.pdf` |
| | 3003 | 受信通知（消費税） | `3003_受信通知_2508.pdf` |
| | 3004 | 納付情報（消費税） | `3004_納付情報_2508.pdf` |
| **会計書類** | 5001 | 決算書 | `5001_決算書_2508.pdf` |
| | 5002 | 総勘定元帳 | `5002_総勘定元帳_2508.pdf` |
| | 5003 | 補助元帳 | `5003_補助元帳_2508.pdf` |
| | 5004 | 残高試算表 | `5004_残高試算表_2508.pdf` |
| | 5005 | 仕訳帳 | `5005_仕訳帳_2508.pdf` |
| | **5006** | **仕訳帳（CSV）** | `5006_仕訳帳_2508.csv` |
| **固定資産** | 6001 | 固定資産台帳 | `6001_固定資産台帳_2508.pdf` |
| | 6002 | 一括償却資産明細表 | `6002_一括償却資産明細表_2508.pdf` |
| | 6003 | 少額減価償却資産明細表 | `6003_少額減価償却資産明細表_2508.pdf` |
| **税区分集計** | 7001 | 勘定科目別税区分集計表 | `7001_勘定科目別税区分集計表_2508.pdf` |
| | 7002 | 税区分集計表 | `7002_税区分集計表_2508.pdf` |

## 🏗️ 過去アップデート履歴

### 🎯 v5.4.2 Stable Threading Edition（2025年9月13日）
**重大Threading Scope問題解決リリース**

#### 🔧 主要変更内容
- ✅ **法改正対応の簡潔化** - 将来の法改正時の影響を最小限に抑制
- ✅ **リネーム名称の最適化**:
  - `0001_法人税及び地方法人税申告書` → `0001_法人税等申告書`
  - `3001_消費税及び地方消費税申告書` → `3001_消費税等申告書`
- ✅ **分類精度の完全維持** - OCR検出キーワードは高精度維持のため据え置き
- ✅ **運用負荷軽減** - 名称変更時の影響範囲を最小化
- ✅ **全機能正常動作確認** - Bundle分割・UI強制適用・連番処理すべて正常

#### 💡 法改正対応設計思想
```yaml
設計方針:
  分類処理: 詳細名称で高精度検出維持
  リネーム処理: 簡潔名称で法改正対応力確保
  分離アーキテクチャ: 分類ロジックとリネーム名称の独立性
  
実装効果:
  影響範囲: リネーム出力のみ（分類条件は無変更）
  運用性: 法改正時の作業負荷を大幅軽減
  互換性: 既存システム・設定への影響なし
```

### 📋 v5.4.1 Balance Trial Classification Fix（2025年9月8日）
**重大な分類問題を解決した緊急修正版**

#### 📋 修正内容
- ✅ **残高試算表分類問題の根本解決** - "残高試算表_貸借対照表_損益計算書" ファイルの正確な分類
- ✅ **分類優先度の再設計** - 5004_残高試算表を最優先度140に設定
- ✅ **除外キーワードシステム** - 5001_決算書に["残高試算表", "試算表", "残高試算"]除外キーワード追加
- ✅ **OCR検出キーワード強化** - partial_keywords拡張による検出精度向上
- ✅ **Bundle分割処理最適化** - 地方税受信通知の連番処理強化
- ✅ **実環境テスト完了** - 実際の問題ファイルでの動作検証完了

### 📈 v5.3.5-ui-robust エンタープライズ改善ポイント
- **🎯 UI強制システム**: 重要書類の期間値100%UI入力保証・エラー完全防止
- **🔄 RunConfig伝搬**: Bundle分割処理での設定値確実継承システム
- **🏢 JobContext管理**: 単一責任・中央集権によるYYMM一元管理
- **🤖 MCP統合**: Claude Code完全統合・体系的開発ワークフロー
- **📊 Enterprise Quality**: 86%保守性向上・40%処理速度高速化達成
- **🔍 品質保証**: エンタープライズレベル包括的テスト・SOLID原則適用

### 🎯 v5.3.5-ui-robust エンタープライズ使用シーン
1. **🏢 エンタープライズ税務管理**: 固定資産台帳・償却資産明細の確実な期間値管理
2. **🎯 重要書類処理**: 納付税額一覧表等の期間値UI強制入力保証
3. **🔄 Bundle分割処理**: 複数書類PDFでの設定値確実継承
4. **🤖 開発ワークフロー**: AddFunc-BugFix 6フェーズ体系的開発プロセス
5. **📊 品質保証**: エンタープライズレベル継続的品質改善

## 🚀 v5.3.5-ui-robust UI強制適用システム

### 📋 UI強制適用ルール
重要書類に対して、確実なYYMM値管理を実現します。

**UI強制適用対象:**
- **固定資産台帳（6001）**: 100%UI入力値使用
- **一括償却資産明細表（6002）**: 100%UI入力値使用
- **少額減価償却資産明細表（6003）**: 100%UI入力値使用
- **納付税額一覧表（0000）**: 100%UI入力値使用

### 🔧 JobContext中央集権管理
```python
@dataclass
class JobContext:
    job_id: str
    confirmed_yymm: Optional[str]
    yymm_source: str
    run_config: Optional[RunConfig]
    
    def get_yymm_for_classification(self, classification_code: str) -> str:
        code4 = classification_code[:4] if classification_code else ""
        ui_forced_codes = {"6001", "6002", "6003", "0000"}
        
        if code4 in ui_forced_codes:
            if not self.confirmed_yymm or self.yymm_source not in ("UI", "UI_FORCED"):
                raise ValueError(f"[FATAL][JOB_CONTEXT] UI YYMM required but missing for {code4}")
        
        return self.confirmed_yymm or ""
```

---

**🤖 Generated with [Claude Code](https://claude.ai/code)**  
**Co-Authored-By: Claude <noreply@anthropic.com>**