# 税務書類リネームシステム v3.0 要件定義書

## 📖 概要
PDFおよびCSVファイルから税務書類を自動分類・リネームし、標準化されたファイル名で整理するシステム

## 🎯 主要機能

### 1. ファイル処理機能
- **対応形式**: PDF, CSV
- **入力方法**: 個別選択、フォルダ一括選択、ドラッグ&ドロップ
- **OCR機能**: Tesseract による日本語テキスト認識
- **分割機能**: 複数書類が含まれるPDFの自動分割

### 2. 書類分類機能
自動判定により以下の書類を分類：

#### 申告書類（0000番台）
- `0000_納付税額一覧表_YYMM.pdf`
- `0001_法人税及び地方法人税申告書_YYMM.pdf`
- `0002_添付資料_法人税_YYMM.pdf`
- `0003_受信通知_法人税_YYMM.pdf`
- `0004_納付情報_法人税_YYMM.pdf`

#### 都道府県関連（1000番台）- 連番対応
- `1001_東京都_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf`
- `1011_愛知県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf`
- `1021_福岡県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf`
- `1031_XXX県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf`
- `1041_XXX県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf`
- `1003_受信通知_都道府県_YYMM.pdf`（1番目）
- `1013_受信通知_都道府県_YYMM.pdf`（2番目）
- `1004_納付情報_都道府県_YYMM.pdf`

#### 市町村関連（2000番台）- 連番対応
- `2001_愛知県蒲郡市_法人市民税_YYMM.pdf`
- `2011_福岡県福岡市_法人市民税_YYMM.pdf`
- `2021_XXX県XXX市_法人市民税_YYMM.pdf`
- `2031_XXX県XXX市_法人市民税_YYMM.pdf`
- `2041_XXX県XXX市_法人市民税_YYMM.pdf`
- `2003_受信通知_市町村_YYMM.pdf`（1番目）
- `2013_受信通知_市町村_YYMM.pdf`（2番目）
- `2023_受信通知_市町村_YYMM.pdf`（3番目）
- `2004_納付情報_市町村_YYMM.pdf`

#### 消費税関連（3000番台）
- `3001_消費税申告書_YYMM.pdf`
- `3002_添付資料_消費税_YYMM.pdf`
- `3003_受信通知_消費税_YYMM.pdf`
- `3004_納付情報_消費税_YYMM.pdf`

#### 会計書類（5000番台）
- `5001_決算書_YYMM.pdf`
- `5002_総勘定元帳_YYMM.pdf`
- `5003_補助元帳_YYMM.pdf`
- `5004_残高試算表_YYMM.pdf`
- `5005_仕訳帳_YYMM.pdf`

#### 固定資産関連（6000番台）
- `6001_固定資産台帳_YYMM.pdf`
- `6002_一括償却資産明細表_YYMM.pdf`
- `6003_少額減価償却資産明細表_YYMM.pdf`

#### 税区分関連（7000番台）
- `7001_勘定科目別税区分集計表_YYMM.pdf`
- `7002_税区分集計表_YYMM.pdf`

### 3. 年月処理優先順位（重要）
1. **手動入力値（最優先）**: ユーザーがYYMM欄に入力した値
2. **自動抽出値**: PDFから抽出した年月情報
3. **デフォルト値**: "YYMM"

### 4. 自治体情報処理
#### 入力方式
- セット1〜5による最大5自治体の手動入力
- 東京都は必ずセット1に配置（市町村入力不要）

#### OCR連携強化
- **検出対象**: 「〇〇県知事」「〇〇市長」「〇〇都」等の行政機関名
- **検出範囲**: PDF 1ページ目の中央上部エリア
- **照合処理**: OCR結果と手動入力セットの自動マッチング
- **連番生成**: マッチした順序で1001→1011→1021...の連番付与

### 5. PDF分割機能（新機能）
#### 国税受信通知一式の分割
**分割対象**: 4種類書類+空白ページが含まれるPDF
```
分割後:
- 0003_受信通知_法人税_YYMM.pdf
- 0004_納付情報_法人税_YYMM.pdf
- 3003_受信通知_消費税_YYMM.pdf
- 3004_納付情報_消費税_YYMM.pdf
```

#### 地方税受信通知一式の分割
**分割対象**: 7種類書類が含まれるPDF
```
分割後:
- 1003_受信通知_都道府県_YYMM.pdf（1番目）
- 1013_受信通知_都道府県_YYMM.pdf（2番目） 
- 1004_納付情報_都道府県_YYMM.pdf
- 2003_受信通知_市町村_YYMM.pdf（1番目）
- 2013_受信通知_市町村_YYMM.pdf（2番目）
- 2023_受信通知_市町村_YYMM.pdf（3番目）
- 2004_納付情報_市町村_YYMM.pdf
```

### 6. CSVファイル対応（新機能）
- **仕訳帳CSVの処理**: ファイル名および内容から書類種別を判定
- **リネーム**: PDF同様の命名規則を適用
- **例**: `仕訳帳_20250818_1018.csv` → `5005_仕訳帳_2508.csv`

## 🔧 技術要件

### 必須ライブラリ
```txt
PyPDF2==3.0.1          # PDF基本処理
PyMuPDF==1.26.3        # 高度PDF処理・分割
pytesseract==0.3.13    # OCR機能
Pillow==11.3.0          # 画像処理
pyinstaller==6.15.0    # exe化
pandas>=2.0.0          # CSV処理（新規追加）
```

### UI要件
- **タブ形式**: ファイル選択・処理結果・開発者ログ
- **プログレスバー**: 処理進行状況表示
- **色分け表示**: 成功/要確認/エラーの視覚的区別
- **ドラッグ&ドロップ対応**: ファイル選択の利便性向上

## 🧪 テスト要件

### 機能テスト
1. **ファイル選択**: PDF・CSV両方の選択・読み込み
2. **OCR処理**: 日本語テキストの正確な抽出
3. **書類判定**: 各カテゴリの正確な分類
4. **年月処理**: 手動入力優先の確認
5. **自治体連番**: OCRとの連携動作
6. **分割機能**: 複数書類PDFの正確な分割
7. **CSV処理**: CSVファイルの正常処理

### パフォーマンステスト
- **処理速度**: 22件のファイルを2秒以内に処理
- **メモリ使用量**: 大量ファイル処理時の安定性
- **エラー処理**: 不正ファイルの適切なハンドリング

## 📋 品質要件

### 精度要求
- **書類分類精度**: 95%以上
- **年月抽出精度**: 90%以上  
- **自治体認識精度**: 85%以上
- **PDF分割精度**: 90%以上

### 運用要件
- **Tesseract OCR**: 日本語パッケージ必須
- **Windows対応**: Windows 10/11
- **スタンドアローン**: インターネット接続不要
- **ログ出力**: 詳細な処理ログの保存

## 🚀 実装フェーズ

### Phase 1: 基本修正（即座実装）
- ✅ 手動入力年月の優先処理
- ✅ 法人税申告書の分類修正  
- ✅ CSVファイル対応
- ✅ 税区分集計表の分類改善

### Phase 2: OCR強化（中期実装）
- 🔄 自治体名OCR精度向上
- 🔄 連番処理の改善
- 🔄 キーワード検出範囲の最適化

### Phase 3: 分割機能（長期実装）
- 🔜 国税受信通知一式の自動分割
- 🔜 地方税受信通知一式の自動分割
- 🔜 分割処理のユーザー設定機能

---

## 📚 関連ドキュメント
- [ISSUES_v2.9.md](./ISSUES_v2.9.md) - 現行版の修正点
- [README.md](./README.md) - システム概要
- [tax_document_renamer.py](./tax_document_renamer.py) - メインソースコード