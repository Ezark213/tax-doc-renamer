# 税務書類リネームシステム v5.0 判定キーワード完全ガイド 📚

## 目次
1. [重要な修正点](#重要な修正点)
2. [正しい番号体系ルール](#正しい番号体系ルール)
3. [判定キーワード詳細解説](#判定キーワード詳細解説)
4. [問題の原因と修正案](#問題の原因と修正案)
5. [実際の処理例](#実際の処理例)

---

## 重要な修正点 🚨

### ❌ 現在の問題点
v5.0で発見された4つの重大な問題：

#### ①ファイル名に不要な文言が追加される
```
❌ 間違い：
- 0003_受信通知_2508.pdf → 1001_受信通知_法人税_2508.pdf
- 3003_受信通知_2508.pdf → 3003_受信通知_消費税_2508.pdf  
- 0004_納付情報_2508.pdf → 1001_納付情報_消費税_2508.pdf
- 2004_納付情報_2508.pdf → 2004_納付情報_市町村_2508.pdf

✅ 正解：
- 0003_受信通知_2508.pdf
- 3003_受信通知_2508.pdf
- 0004_納付情報_2508.pdf
- 3004_納付情報_2508.pdf
- 1004_納付情報_2508.pdf
- 2004_納付情報_2508.pdf
```

#### ②番号の末尾ルールが無視される
```
正しいルール：
- 受信通知：必ず末尾が「3」（0003, 3003, 1003, 1013, 1023, 2003, 2013, 2023）
- 納付情報：必ず末尾が「4」（0004, 3004, 1004, 2004）

❌ 現在の間違い：
- 法人税受信通知 → 1001_受信通知_法人税（1001は都道府県申告書の番号！）
- 消費税納付情報 → 1001_納付情報_消費税（1001は都道府県申告書の番号！）
```

#### ③自治体連番が正しく適用されない
```
設定：
- セット1：東京都
- セット2：愛知県蒲郡市  
- セット3：福岡県福岡市

❌ 現在の結果：
- 都道府県：東京都→1001、愛知県→1011、福岡県→1021（部分的に正常）
- 市町村：蒲郡市→2001、福岡市→2011（生成されるべきだが不完全）

✅ 期待される結果：
- 都道府県：1001_東京都、1011_愛知県、1021_福岡県
- 市町村：2001_愛知県蒲郡市、2011_福岡県福岡市（東京都は除外）
```

#### ④自治体認識のロジック問題
```
❌ 問題：常に東京が1001として認識される
ログ例：
[DEBUG] 都道府県マッチ: 東京 → 1001（他の県の書類でも東京が検出）
[DEBUG] 市町村マッチ: 蒲郡 → 2001（正しい）
```

---

## 正しい番号体系ルール 📋

### 🎯 基本構造
```
XXXX_書類名_YYMM.pdf
└─┬─┘       └─┬──┘
  │           └─ 年月（2508 = 2025年8月）
  └─ 4桁の分類番号
```

### 📊 番号の末尾ルール
| 末尾数字 | 書類種別 | 例 |
|---------|----------|-----|
| **1** | 申告書本体 | 0001, 3001, 1001, 2001 |
| **2** | 添付資料 | 0002, 3002 |
| **3** | **受信通知** | **0003, 3003, 1003, 1013, 1023, 2003, 2013, 2023** |
| **4** | **納付情報** | **0004, 3004, 1004, 2004** |
| **5-9** | その他 | 会計書類（5001-7002） |

### 🔢 連番ルール詳細

#### 都道府県関連（1000番台）
```
1001: 1番目の都道府県（必ず東京都）
1011: 2番目の都道府県
1021: 3番目の都道府県  
1031: 4番目の都道府県
1041: 5番目の都道府県

固定番号：
1003: 都道府県受信通知（連番なし）
1004: 都道府県納付情報（連番なし）
```

#### 市町村関連（2000番台）
```
2001: 1番目の市町村（東京都を除く1番目）
2011: 2番目の市町村
2021: 3番目の市町村
2031: 4番目の市町村  
2041: 5番目の市町村

連番あり（市町村数に応じて）：
2003: 1番目の市町村受信通知
2013: 2番目の市町村受信通知
2023: 3番目の市町村受信通知

固定番号：
2004: 市町村納付情報（連番なし）
```

---

## 判定キーワード詳細解説 🔍

### 🏛️ 国税関連（0000-0004, 3000-3004）

#### **0003_受信通知**（法人税の受信通知）
- **用途**: 法人税申告が受け付けられた通知書
- **正しいファイル名**: `0003_受信通知_2508.pdf`
- **❌ 現在の間違い**: `1001_受信通知_法人税_2508.pdf`
- **判定キーワード**:
  ```
  最優先AND条件（両方必要）：
  - "メール詳細"
  - "種目 法人税及び地方法人税申告書"
  ```
- **説明**: 法人税の申告書を税務署に送った時に返ってくる「受け取りました」という証明書

#### **0004_納付情報**（法人税の納付情報）
- **用途**: 法人税を支払うための情報
- **正しいファイル名**: `0004_納付情報_2508.pdf`
- **❌ 現在の間違い**: `1001_受信通知_法人税_2508.pdf`（受信通知として誤分類）
- **判定キーワード**:
  ```
  最優先AND条件（3つ全て必要）：
  - "受付番号"
  - "税目 法人税"  
  - "受付日時"
  ```
- **説明**: 法人税をいくら払うか、どうやって払うかが書かれた書類

#### **3003_受信通知**（消費税の受信通知）
- **用途**: 消費税申告が受け付けられた通知書
- **正しいファイル名**: `3003_受信通知_2508.pdf`
- **❌ 現在の間違い**: `3003_受信通知_消費税_2508.pdf`（余計な文言追加）
- **判定キーワード**:
  ```
  最優先AND条件（両方必要）：
  - "メール詳細"
  - "種目 消費税申告書"
  ```
- **説明**: 消費税の申告書を税務署に送った時に返ってくる「受け取りました」という証明書

#### **3004_納付情報**（消費税の納付情報）
- **用途**: 消費税を支払うための情報
- **正しいファイル名**: `3004_納付情報_2508.pdf`
- **❌ 現在の間違い**: `1001_納付情報_消費税_2508.pdf`（番号が完全に間違い）
- **判定キーワード**:
  ```
  最優先AND条件（両方必要）：
  - "メール詳細（納付区分番号通知）"
  - "消費税及地方消費税"
  ```
- **説明**: 消費税をいくら払うか、どうやって払うかが書かれた書類

### 🏢 地方税関連（1000-2000番台）

#### **1003_受信通知**（都道府県税の受信通知）
- **用途**: 都道府県税申告が受け付けられた通知書
- **正しいファイル名**: `1003_受信通知_2508.pdf`
- **連番なし**: 都道府県が複数あっても1003固定
- **判定キーワード**: 都道府県税に関する受信通知のキーワード

#### **1004_納付情報**（都道府県税の納付情報）  
- **用途**: 都道府県税を支払うための情報
- **正しいファイル名**: `1004_納付情報_2508.pdf`
- **❌ 現在の結果**: `1004_納付情報_都道府県_2508.pdf`（余計な文言追加）
- **判定キーワード**:
  ```
  最優先AND条件（両方必要）：
  - "納付情報発行結果"
  - "法人二税・特別税"
  ```

#### **2003系列_受信通知**（市町村税の受信通知）
- **用途**: 市町村税申告が受け付けられた通知書
- **正しいファイル名**:
  ```
  2003_受信通知_2508.pdf（1番目の市町村）
  2013_受信通知_2508.pdf（2番目の市町村）
  2023_受信通知_2508.pdf（3番目の市町村）
  ```
- **❌ 現在の間違い**: `2001_受信通知_市町村_2508.pdf`（番号が間違い）
- **判定キーワード**:
  ```
  最優先AND条件（両方必要）：
  - "申告受付完了通知"
  - "法人市町村民税"
  ```

#### **2004_納付情報**（市町村税の納付情報）
- **用途**: 市町村税を支払うための情報  
- **正しいファイル名**: `2004_納付情報_2508.pdf`
- **❌ 現在の間違い**: `2004_納付情報_市町村_2508.pdf`（余計な文言追加）
- **連番なし**: 市町村が複数あっても2004固定
- **判定キーワード**:
  ```
  最優先AND条件（両方必要）：
  - "納付情報発行結果"
  - "法人住民税"
  ```

### 📊 申告書本体（末尾1）

#### **1001系列_都道府県申告書**
- **用途**: 都道府県に納める税金の申告書
- **正しいファイル名**:
  ```
  1001_東京都_法人都道府県民税・事業税・特別法人事業税_2508.pdf
  1011_愛知県_法人都道府県民税・事業税・特別法人事業税_2508.pdf  
  1021_福岡県_法人都道府県民税・事業税・特別法人事業税_2508.pdf
  ```
- **判定キーワード**:
  ```
  最優先AND条件（3つ全て必要）：
  条件1: "県税事務所" + "法人事業税" + "特別法人事業税"
  条件2: "都税事務所" + "道府県民税" + "事業税"
  ```

#### **2001系列_市町村申告書**  
- **用途**: 市町村に納める税金の申告書
- **正しいファイル名**:
  ```
  2001_愛知県蒲郡市_法人市民税_2508.pdf（1番目の市町村）
  2011_福岡県福岡市_法人市民税_2508.pdf（2番目の市町村）
  ```
- **東京都除外**: 東京都には市町村分の申告書は存在しない

---

## 問題の原因と修正案 🔧

### 🚨 原因1：自治体連番ロジックの誤動作

**問題**:
```python
# 受信通知・納付情報に自治体連番が適用されている
❌ 0003_受信通知_法人税 → 1001_受信通知_法人税
❌ 3004_納付情報_消費税 → 1001_納付情報_消費税
```

**修正案**:
```python
# 受信通知・納付情報は番号固定にする
✅ 法人税受信通知 → 0003_受信通知_YYMM.pdf（固定）
✅ 消費税納付情報 → 3004_納付情報_YYMM.pdf（固定）
✅ 都道府県納付情報 → 1004_納付情報_YYMM.pdf（固定）
✅ 市町村納付情報 → 2004_納付情報_YYMM.pdf（固定）

# 連番が適用されるのは受信通知の一部のみ
✅ 市町村受信通知のみ → 2003, 2013, 2023...（連番あり）
```

### 🚨 原因2：ファイル名生成ロジックの問題

**問題**:
```python
# 不要な説明文言が追加される
❌ "受信通知_法人税"
❌ "納付情報_消費税" 
❌ "納付情報_市町村"
```

**修正案**:
```python
# シンプルなファイル名にする
✅ "受信通知"（税目は番号で判別）
✅ "納付情報"（税目は番号で判別）

# 番号による自動判別：
0003 → 法人税の受信通知
3003 → 消費税の受信通知  
0004 → 法人税の納付情報
3004 → 消費税の納付情報
```

### 🚨 原因3：自治体認識の精度問題

**問題**:
```python
# 他県の書類でも東京が検出される
❌ 都道府県マッチ: 東京 → 1001（愛知県の書類なのに）
❌ 都道府県マッチ: 東京 → 1001（福岡県の書類なのに）
```

**修正案**:
```python
# より精密な自治体認識ルール
✅ ファイル名優先：メトロノーム_愛知県東三河県税事務所 → 愛知県
✅ OCRテキスト優先：実際の書類内容から正確に判定
✅ セット設定との照合：設定された自治体リストと照合
```

---

## 実際の処理例 📝

### 🎯 例1：受信通知の正しい処理

**入力ファイル**: `0003_受信通知_2508【元々3_国税】.pdf`

**現在の間違った処理**:
```
1. 法人税受信通知として判定 ✅
2. 自治体連番を適用 ❌
3. 結果: 1001_受信通知_法人税_2508.pdf ❌
```

**正しい処理**:
```
1. 法人税受信通知として判定 ✅
2. 自治体連番を適用しない ✅  
3. 結果: 0003_受信通知_2508.pdf ✅
```

### 🎯 例2：納付情報の正しい処理  

**入力ファイル**: `3004_納付情報_2508【元々2_国税】.pdf`

**現在の間違った処理**:
```
1. 消費税納付情報として判定 ✅
2. 都道府県連番を適用 ❌
3. 結果: 1001_納付情報_消費税_2508.pdf ❌
```

**正しい処理**:
```
1. 消費税納付情報として判定 ✅
2. 連番を適用しない ✅
3. 結果: 3004_納付情報_2508.pdf ✅
```

### 🎯 例3：市町村受信通知の正しい処理

**入力ファイル**: `2013_受信通知_2508【元々3_地方税】.pdf`

**現在の間違った処理**:
```
1. 市町村受信通知として判定 ✅
2. 市町村連番を2011に適用 ❌（ファイル名は2013だが中身は2011として処理）
3. 結果: 2011_受信通知_市町村_2508.pdf ❌
```

**正しい処理**:
```
1. 市町村受信通知として判定 ✅
2. 2番目の市町村として2013を適用 ✅
3. 結果: 2013_受信通知_2508.pdf ✅
```

---

## 📋 完全修正チェックリスト

### ✅ 受信通知の修正
- [ ] 0003_受信通知_YYMM.pdf（法人税、連番なし）
- [ ] 3003_受信通知_YYMM.pdf（消費税、連番なし）  
- [ ] 1003_受信通知_YYMM.pdf（都道府県税、連番なし）
- [ ] 2003_受信通知_YYMM.pdf（1番目市町村）
- [ ] 2013_受信通知_YYMM.pdf（2番目市町村）
- [ ] 2023_受信通知_YYMM.pdf（3番目市町村）

### ✅ 納付情報の修正  
- [ ] 0004_納付情報_YYMM.pdf（法人税、連番なし）
- [ ] 3004_納付情報_YYMM.pdf（消費税、連番なし）
- [ ] 1004_納付情報_YYMM.pdf（都道府県税、連番なし）
- [ ] 2004_納付情報_YYMM.pdf（市町村税、連番なし）

### ✅ 自治体連番の修正
- [ ] 1001_東京都_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf  
- [ ] 1011_愛知県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
- [ ] 1021_福岡県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
- [ ] 2001_愛知県蒲郡市_法人市民税_YYMM.pdf
- [ ] 2011_福岡県福岡市_法人市民税_YYMM.pdf

---

## 🆘 緊急確認事項

### 🔍 v5.0の存在について
**重要**: GitHubでのリポジトリ調査結果
- `https://github.com/Ezark213/tax-doc-renamer` は**確認できませんでした**
- 非公開リポジトリまたは削除済みの可能性があります
- 使用中のv5.0の正確な入手先の確認が必要です

### 📞 推奨される対応
1. **開発者に直接確認**: リポジトリの状況と最新版について  
2. **設定ファイルの確認**: 現在の判定ルール設定を直接確認
3. **ログ詳細分析**: より詳細なデバッグログの取得

---

**📅 更新日**: 2025年8月27日  
**🏷️ バージョン**: v5.0対応  
**👨‍💻 分析者**: プロエンジニア（要件定義専門）

この解説により、v5.0の問題点と修正すべき判定ルールが明確になりました。
特に「番号の末尾ルール」と「不要な文言追加の排除」が重要な修正ポイントです。