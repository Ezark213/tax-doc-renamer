# 税務書類リネームシステム v3.1 包括的修正要件

## 📅 更新日時
**2025年8月20日** - 包括的要件整理

## 🎯 開発方針
- **ゼロベース構築**: 既存問題を根本から解決
- **ドキュメント駆動**: GitHub上で要件 → 実装の流れ
- **段階的開発**: 優先順位に基づく実装

---

## 🚨 高優先度修正項目

### 1. YYMM優先順位の根本修正 🔴
**現状問題**: OCR画像認識が手動入力より優先される
**要求修正**:
```python
# 優先順位（必須）
1. ユーザー手動入力YYMM（最優先・強制）
2. ファイル名からの推定
3. OCR画像認識（補完のみ）
```

### 2. CSV対応の完全実装 🔴
**現状**: CSVファイルが処理できない
**要求**:
- CSVファイル読み込み機能
- PDF仕訳帳: `5005_仕訳帳_YYMM.pdf`
- CSV仕訳帳: `5006_仕訳帳_YYMM.csv`

### 3. 税区分集計表の明確分類 🔴
**現状**: 2種類が同一視される
**要求修正**:
```
勘定科目別税区分集計表 → 7001_勘定科目別税区分集計表_YYMM
税区分集計表 → 7002_税区分集計表_YYMM
```

---

## 🟡 中優先度機能追加

### 4. ドラッグアンドドロップUI 🟡
**要求**: ファイル選択の利便性向上
- ドラッグアンドドロップ対応
- 複数ファイル同時処理

### 5. タブ形式インターフェース 🟡
**要求UI設計**:
```
┌─ [ファイル選択] [処理設定] [デバッグログ] ┐
│                                        │
│  ドラッグ&ドロップエリア                   │
│  または「ファイル選択」ボタン               │
│                                        │
└────────────────────────────────────────┘
```

### 6. 豊富なデバッグログ機能 🟡
**要求機能**:
- 処理ステップの詳細表示
- OCR認識結果の可視化
- ファイル名決定プロセス表示
- エラー詳細情報

---

## 🔵 低優先度改善項目

### 7. PDF分割機能
- 複数書類含有PDFの自動分割
- 受信通知と納付情報の分離

### 8. 自治体別連番強化
- OCRによる自治体名認識
- 都道府県・市町村の自動連番

---

## 📋 詳細技術仕様

### ファイル命名規則強化
```python
# PDF書類
PDF_NAMING = {
    "法人税申告書": "0001_法人税及び地方法人税申告書_{YYMM}.pdf",
    "PDF仕訳帳": "5005_仕訳帳_{YYMM}.pdf",
    "勘定科目別税区分集計表": "7001_勘定科目別税区分集計表_{YYMM}.pdf",
    "税区分集計表": "7002_税区分集計表_{YYMM}.pdf"
}

# CSV書類
CSV_NAMING = {
    "CSV仕訳帳": "5006_仕訳帳_{YYMM}.csv"
}
```

### YYMM判定ロジック
```python
def determine_yymm(user_input, filename, ocr_result):
    """YYMM決定の優先順位ロジック"""
    if user_input:
        return user_input  # 最優先
    elif filename_yymm := extract_from_filename(filename):
        return filename_yymm  # 第2優先
    elif ocr_yymm := extract_from_ocr(ocr_result):
        return ocr_yymm  # 補完的
    else:
        return "0000"  # デフォルト
```

### タブ構造設計
```python
class TabbedInterface:
    def __init__(self):
        self.notebook = ttk.Notebook()
        self.create_file_tab()      # ファイル選択
        self.create_settings_tab()  # 処理設定
        self.create_debug_tab()     # デバッグログ
        
    def create_file_tab(self):
        # ドラッグ&ドロップエリア
        # ファイルリスト表示
        
    def create_debug_tab(self):
        # リアルタイムログ表示
        # OCR結果表示
        # 処理フロー可視化
```

---

## 🧪 テスト項目

### 必須テスト
- [ ] 手動入力YYMM最優先確認
- [ ] CSV仕訳帳の正しい命名（5006_）
- [ ] 税区分集計表の分類（7001/7002）
- [ ] ドラッグ&ドロップ動作
- [ ] タブ切り替え機能

### 回帰テスト
- [ ] PDF処理正常動作
- [ ] OCR機能正常動作
- [ ] 既存命名規則維持

---

## 📂 ファイル構造

### 新規作成予定
```
tax-doc-renamer/
├── src/
│   ├── main.py                 # メインアプリケーション
│   ├── ui/
│   │   ├── tabbed_interface.py # タブUI
│   │   └── drag_drop.py        # D&D機能
│   ├── processors/
│   │   ├── pdf_processor.py    # PDF処理
│   │   ├── csv_processor.py    # CSV処理
│   │   └── ocr_processor.py    # OCR処理
│   └── utils/
│       ├── file_naming.py      # 命名ルール
│       └── debug_logger.py     # デバッグ機能
├── tests/                      # テストファイル
├── docs/                       # ドキュメント
└── requirements.txt            # 依存関係
```

---

## 🚀 実装スケジュール

### Phase 1: 基盤構築 (Day 1-2)
1. ゼロベースプロジェクト構築
2. タブUI基本構造
3. YYMM優先順位修正

### Phase 2: 機能実装 (Day 3-4) 
4. CSV対応完全実装
5. 税区分集計表分類
6. ドラッグ&ドロップ機能

### Phase 3: 改善・テスト (Day 5)
7. デバッグログ強化
8. 統合テスト
9. exe化とデプロイ

---

## 📊 成功指標

### 機能面
- [ ] 全ファイル種別の正確な識別
- [ ] ユーザー入力YYMM 100%反映
- [ ] CSV/PDF両対応

### UX面  
- [ ] ドラッグ&ドロップ操作可能
- [ ] 詳細デバッグ情報表示
- [ ] 直感的なタブ操作

### 安定性
- [ ] エラー時の詳細情報提供
- [ ] 処理失敗ファイルの明確化
- [ ] ログによる問題追跡可能性