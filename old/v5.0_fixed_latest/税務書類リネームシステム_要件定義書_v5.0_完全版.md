# 税務書類画像認識・分割・リネームシステム 要件定義書 v5.0 完全版

**文書管理情報**
- 版数: v5.0.0
- 作成日: 2025年8月29日
- 最終更新: 2025年8月29日
- 作成者: システム要件定義エンジニア
- 承認: 運用管理者

---

## 目次

1. [システム概要](#1-システム概要)
2. [機能要件](#2-機能要件)
3. [非機能要件](#3-非機能要件)
4. [システム要件](#4-システム要件)
5. [配布・インストール要件](#5-配布インストール要件)
6. [運用・保守要件](#6-運用保守要件)
7. [セキュリティ要件](#7-セキュリティ要件)
8. [データ要件](#8-データ要件)
9. [インターフェース要件](#9-インターフェース要件)
10. [品質保証要件](#10-品質保証要件)

---

## 1. システム概要

### 1.1 目的
税務署へ提出する各種申告書類のPDFファイルを、画像認識（OCR）技術により自動で書類種別を判定し、統一された命名規則に従って自動リネームするシステムを提供する。

### 1.2 適用範囲
- 国税申告書類（法人税、消費税）
- 地方税申告書類（都道府県税、市町村税）
- 会計書類（決算書、元帳、試算表等）
- 固定資産関連書類
- 税区分関連書類

### 1.3 システムの特徴
- **完全オフライン動作**: インターネット接続不要
- **自動分類**: AI画像認識による書類種別自動判定
- **複数自治体対応**: 最大5自治体への同時対応
- **AND条件分類**: 複数キーワードの同時マッチング判定
- **セットベース連番**: 自治体ごとの体系的な番号付け

---

## 2. 機能要件

### 2.1 書類分類機能

#### 2.1.1 自動分類対象書類

**国税関連書類（0000番台）**
| 番号 | 書類名 | 説明 |
|------|--------|------|
| 0000 | 納付税額一覧表 | 各種税金の納付金額一覧 |
| 0001 | 法人税及び地方法人税申告書 | 法人税申告書本体 |
| 0002 | 添付資料（法人税） | 法人税申告書添付資料 |
| 0003 | 受信通知（法人税） | 法人税申告受信通知 |
| 0004 | 納付情報（法人税） | 法人税納付情報 |

**都道府県税関連書類（1000番台）**
| 番号 | 書類名 | 説明 |
|------|--------|------|
| 1001, 1011, 1021... | 法人都道府県民税・事業税・特別法人事業税 | 都道府県申告書（連番） |
| 1003 | 受信通知（都道府県） | 都道府県税受信通知 |
| 1004 | 納付情報（都道府県） | 都道府県税納付情報 |

**市町村税関連書類（2000番台）**
| 番号 | 書類名 | 説明 |
|------|--------|------|
| 2001, 2011, 2021... | 法人市民税 | 市町村申告書（連番） |
| 2003, 2013, 2023... | 受信通知（市町村） | 市町村税受信通知（連番） |
| 2004 | 納付情報（市町村） | 市町村税納付情報 |

**消費税関連書類（3000番台）**
| 番号 | 書類名 | 説明 |
|------|--------|------|
| 3001 | 消費税及び地方消費税申告書 | 消費税申告書本体 |
| 3002 | 添付資料（消費税） | 消費税申告書添付資料 |
| 3003 | 受信通知（消費税） | 消費税申告受信通知 |
| 3004 | 納付情報（消費税） | 消費税納付情報 |

**会計書類（5000番台）**
| 番号 | 書類名 | 説明 |
|------|--------|------|
| 5001 | 決算書 | 貸借対照表・損益計算書等 |
| 5002 | 総勘定元帳 | 会計の総勘定元帳 |
| 5003 | 補助元帳 | 会計の補助元帳 |
| 5004 | 残高試算表 | 会計の残高試算表 |
| 5005 | 仕訳帳 | 会計の仕訳帳 |
| 5006 | 仕訳データ | 仕訳データ（CSV形式） |

**固定資産関連書類（6000番台）**
| 番号 | 書類名 | 説明 |
|------|--------|------|
| 6001 | 固定資産台帳 | 固定資産の台帳 |
| 6002 | 一括償却資産明細表 | 一括償却資産明細 |
| 6003 | 少額減価償却資産明細表 | 少額減価償却資産明細 |

**税区分関連書類（7000番台）**
| 番号 | 書類名 | 説明 |
|------|--------|------|
| 7001 | 勘定科目別税区分集計表 | 勘定科目別税区分集計 |
| 7002 | 税区分集計表 | 税区分集計（勘定科目別以外） |

#### 2.1.2 分類ロジック

**優先度システム**
1. **最優先条件（AND条件）**: 複数キーワードの同時マッチング（優先度100-140）
2. **標準条件**: 単一キーワードマッチング（優先度1-15）
3. **フォールバック**: セット検出失敗時の代替分類

**スコア計算式**
- 完全一致キーワード: 優先度 × 2ポイント
- 部分一致キーワード: 優先度 × 1ポイント
- ファイル名キーワード: 優先度 × 3ポイント（1.5倍）
- 除外キーワード: 該当時スコア = 0（即座に除外）

**信頼度計算**
```
信頼度 = min(最高スコア / 15.0, 1.0)
```
- 信頼度30%未満: 9999_未分類に変更

### 2.2 自治体管理機能

#### 2.2.1 自治体セット管理
- **最大5セット**: 都道府県・市町村のペア
- **東京都制約**: 必ず1番目（セット1）に配置必須
- **連番生成**: 入力順に基づく自動連番（1001, 1011, 1021...）

#### 2.2.2 連番ルール
**都道府県連番**
```
基本番号: 1001
2番目: 1001 + (2-1) × 10 = 1011
3番目: 1001 + (3-1) × 10 = 1021
4番目: 1001 + (4-1) × 10 = 1031  
5番目: 1001 + (5-1) × 10 = 1041
```

**市町村連番**
```
基本番号: 2001
2番目: 2001 + (2-1) × 10 = 2011
3番目: 2001 + (3-1) × 10 = 2021
```

### 2.3 ファイル処理機能

#### 2.3.1 対応ファイル形式
- **入力**: PDF形式
- **出力**: PDF形式（リネーム）、CSV形式（仕訳データ）

#### 2.3.2 ファイル操作
- **ドラッグ&ドロップ**: GUI上への直接ドロップ
- **ファイル選択**: ファイル選択ダイアログ
- **フォルダ一括選択**: フォルダ内PDF一括処理
- **空白ページ除去**: 自動検出・除外

#### 2.3.3 命名規則
```
XXXX_書類名_YYMM.pdf
└─┬─┘       └─┬──┘
  │           └─ 年月（例：2508 = 2025年8月）
  └─ 4桁の分類番号
```

### 2.4 ユーザーインターフェース機能

#### 2.4.1 メイン画面構成
- **タブ1**: ファイル選択・設定
- **タブ2**: 処理結果・ログ表示
- **タブ3**: デバッグ・詳細ログ

#### 2.4.2 入力制御
- **自治体入力**: 最大5セットの都道府県・市町村
- **年月入力**: YYMM形式（例：2508）
- **検証機能**: 東京都位置チェック、形式検証

---

## 3. 非機能要件

### 3.1 性能要件

| 項目 | 要件 | 測定方法 |
|------|------|----------|
| 処理速度 | 1ファイル（10ページ以下）あたり30秒以内 | システムログによる測定 |
| 同時処理 | 最大100ファイルの一括処理 | バッチ処理テスト |
| メモリ使用量 | 4GB以下での動作 | タスクマネージャー監視 |
| ディスク容量 | システム本体: 200MB以下 | インストールサイズ測定 |

### 3.2 可用性要件

| 項目 | 要件 | 説明 |
|------|------|------|
| 稼働率 | 99%以上 | オフライン動作のため高可用性 |
| 障害回復 | 自動復旧機能 | 処理中断時の自動再開 |
| データ保護 | 処理ログ保存 | エラー時の詳細情報保存 |

### 3.3 拡張性要件

| 項目 | 要件 | 説明 |
|------|------|------|
| 書類種別追加 | 新分類ルール追加可能 | 設定ファイル変更による拡張 |
| 自治体追加 | 5セット以上への拡張可能 | アーキテクチャ的対応済み |
| 言語対応 | 多言語対応準備 | UI文字列の外部化 |

---

## 4. システム要件

### 4.1 ハードウェア要件

#### 4.1.1 最小要件
- **OS**: Windows 10 (64bit)
- **CPU**: Intel Core i3相当以上
- **メモリ**: 4GB以上
- **ディスク容量**: 500MB以上の空き容量
- **解像度**: 1024×768以上

#### 4.1.2 推奨要件
- **OS**: Windows 11 (64bit)
- **CPU**: Intel Core i5相当以上
- **メモリ**: 8GB以上
- **ディスク容量**: 1GB以上の空き容量
- **解像度**: 1920×1080以上

### 4.2 ソフトウェア要件

#### 4.2.1 必須要件
- **Tesseract OCR**: システムインストール版またはバンドル版
- **日本語言語パック**: jpn.traineddata必須

#### 4.2.2 互換性要件
- **Python**: 3.12（バンドル版では不要）
- **ランタイム**: Microsoft Visual C++ 2015-2019 Redistributable

---

## 5. 配布・インストール要件

### 5.1 配布形態

#### 5.1.1 OneDir版（推奨）
- **ファイル**: `TaxDocRenamer_v5_OneDir\TaxDocRenamer_v5_System.exe`
- **特徴**: フォルダ形式、ウイルス誤検知回避
- **サイズ**: 約100MB
- **依存関係**: システムTesseract必須

#### 5.1.2 スクリプト起動版
- **バッチファイル**: `launch_tax_renamer.bat`
- **PowerShell**: `launch_tax_renamer.ps1`
- **Python直接**: `python main_v5.py`
- **利点**: 軽量、設定変更容易

#### 5.1.3 OneFile版（代替）
- **ファイル**: `TaxDocRenamer_v5.0_SystemTesseract.exe`
- **特徴**: 単一実行ファイル
- **注意**: アンチウイルス誤検知の可能性

### 5.2 インストール手順

#### 5.2.1 Tesseract事前インストール
1. https://github.com/UB-Mannheim/tesseract/wiki からダウンロード
2. インストール時に日本語言語パック（jpn.traineddata）を含める
3. 確認コマンド: `tesseract --version`

#### 5.2.2 システム配置
1. 配布フォルダを任意の場所に展開
2. `TaxDocRenamer_v5_System.exe`を実行
3. または`launch_tax_renamer.bat`をダブルクリック

### 5.3 配布要件

| 項目 | 要件 | 説明 |
|------|------|------|
| ファイル署名 | 不要（社内利用） | 必要に応じてコード署名可能 |
| インストーラー | zip配布 | シンプルな展開形式 |
| 更新方式 | 手動配布 | バージョンアップ時の差し替え |

---

## 6. 運用・保守要件

### 6.1 ログ・監視要件

#### 6.1.1 ログ出力
- **処理ログ**: 分類結果、実行時間
- **エラーログ**: 例外情報、スタックトレース
- **デバッグログ**: 詳細分類過程

#### 6.1.2 ログ保存期間
- **処理ログ**: 30日間
- **エラーログ**: 90日間
- **ローテーション**: サイズベース（10MB）

### 6.2 バックアップ要件

| 項目 | 対象 | 頻度 | 保存期間 |
|------|------|------|----------|
| 設定ファイル | 分類ルール | 変更時 | 永続 |
| 処理結果 | リネーム履歴 | 日次 | 30日 |
| エラーログ | 障害情報 | 週次 | 90日 |

### 6.3 保守性要件

#### 6.3.1 設定変更
- **分類ルール**: 外部設定ファイル
- **UI言語**: 言語ファイル分離
- **システムパラメータ**: 設定ファイル管理

#### 6.3.2 トラブルシュート
- **詳細ログ**: デバッグモード提供
- **エラー通知**: ユーザーフレンドリーなエラーメッセージ
- **リカバリー**: 処理中断からの自動復旧

---

## 7. セキュリティ要件

### 7.1 データ保護要件

| 項目 | 要件 | 実装方法 |
|------|------|----------|
| データ暗号化 | ローカル処理のため不要 | オフライン動作 |
| アクセス制御 | ファイルシステム権限依存 | OS標準機能利用 |
| 通信暗号化 | 不要 | ネットワーク通信なし |
| ログ保護 | 機密情報の非出力 | ファイル名・パスのマスキング |

### 7.2 プライバシー要件

#### 7.2.1 個人情報保護
- **OCR結果**: ログ出力時のマスキング
- **ファイル名**: 機密情報の非表示
- **処理内容**: ローカル完結処理

#### 7.2.2 データ流出対策
- **オフライン動作**: インターネット接続不要
- **ローカル処理**: 外部送信なし
- **一時ファイル**: 自動削除

---

## 8. データ要件

### 8.1 データ分類

#### 8.1.1 入力データ
- **PDFファイル**: 税務申告書類
- **設定データ**: 自治体情報、年月
- **分類ルール**: 内部データベース

#### 8.1.2 出力データ
- **リネーム済みファイル**: 命名規則適用
- **処理ログ**: CSV形式
- **分類レポート**: 処理結果サマリー

### 8.2 データ整合性

| 項目 | 要件 | 検証方法 |
|------|------|----------|
| ファイル形式 | PDF形式の検証 | ヘッダー確認 |
| 命名規則 | XXXX_名前_YYMM.pdf | 正規表現チェック |
| 年月形式 | YYMM（4桁数字） | 数値範囲チェック |
| 文字エンコーディング | UTF-8 | エンコーディング検証 |

---

## 9. インターフェース要件

### 9.1 ユーザーインターフェース要件

#### 9.1.1 操作性要件
- **直感的操作**: ドラッグ&ドロップ対応
- **視覚的フィードバック**: プログレスバー表示
- **エラー通知**: 分かりやすいエラーメッセージ
- **多言語対応**: 日本語メイン、英語対応可能

#### 9.1.2 アクセシビリティ
- **フォントサイズ**: 可読性を考慮した適切なサイズ
- **コントラスト**: 十分な色彩コントラスト
- **キーボード操作**: マウスなしでの基本操作

### 9.2 外部インターフェース要件

#### 9.2.1 ファイルシステム
- **読み取り**: PDFファイルアクセス
- **書き込み**: リネーム済みファイル出力
- **権限**: 適切なファイルシステム権限

#### 9.2.2 システム連携
- **Tesseract OCR**: コマンドライン連携
- **OS通知**: 処理完了通知
- **ファイル関連付け**: PDF viewer連携

---

## 10. 品質保証要件

### 10.1 テスト要件

#### 10.1.1 機能テスト
- **分類精度テスト**: 各書類種別の分類確認
- **自治体連番テスト**: 連番生成の正確性
- **エラーハンドリングテスト**: 異常系の動作確認

#### 10.1.2 非機能テスト
- **性能テスト**: 処理速度の測定
- **負荷テスト**: 大量ファイル処理
- **ユーザビリティテスト**: 操作性の評価

### 10.2 品質基準

#### 10.2.1 分類精度
- **目標精度**: 95%以上
- **測定方法**: 代表的書類セットでの検証
- **改善基準**: 90%未満の場合はルール調整

#### 10.2.2 信頼性
- **障害発生率**: 1%未満
- **データ整合性**: 100%
- **回復時間**: 30秒以内

---

## 付録

### A. 変更履歴

| 版数 | 日付 | 変更内容 | 承認者 |
|------|------|----------|--------|
| v5.0.0 | 2025-08-29 | 初版作成、5000-7000番台分類対応 | システム管理者 |

### B. 用語集

| 用語 | 説明 |
|------|------|
| OCR | Optical Character Recognition（光学文字認識） |
| AND条件 | 複数キーワードの同時マッチング条件 |
| セットベース連番 | 自治体セットに基づく体系的番号付け |
| OneDir | PyInstallerのフォルダ配布形式 |
| Tesseract | Google開発のOCRエンジン |

### C. 参考資料

- 税務書類リネームシステム番号体系完全ガイド
- tax_doc_requirements_no_keywords.md
- tax_document_numbering_guide.md

---

**文書管理**
- 最終更新: 2025年8月29日
- 次回見直し: 2025年12月
- 承認者: システム運用管理者