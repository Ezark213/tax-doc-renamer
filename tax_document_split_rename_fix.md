# 税務書類分割・リネーム処理 修正要件定義書

## 【背景・目的】
税務書類画像認識システムにおいて、分割処理の判定ロジックとリネーム処理に根本的な問題があり、不要な分割の実行と正しいファイル名付与ができていない状況の修正。

## 【開発方針】
基本的に、修正点と現状を修正の都度ドキュメント化し、修正後に要求される機能をゼロベースで構築すること。その際、githubにドキュメント化⇒生成の流れで効率化

---

## 【現状の課題】

### 🔴 **問題① 不要な分割処理の実行**
```
【現状】消費税申告書等の単一書類が分割されている
【問題】分割不要な書類に対して分割処理が実行され、不正なファイル分割が発生
【影響】単一書類が複数ファイルに分割され、後続処理でエラーが発生
```

### 🔴 **問題② 分割対象の誤判定**
```
【現状】分割不要な書類を誤って分割対象として選択している
【問題】分割判定の条件設定が広すぎるため、単一書類が分割対象と誤認識される
【具体例】全てかどうか不明だが、単一処理すべき書類が分割処理にかけられている
【影響】単一書類が不適切に複数ファイルに分割され、後続のリネーム処理でエラーが発生
```

### 🔴 **問題③ 分割後リネーム処理の異常**
```
【現状】分割後の書類が「コピー後リネーム」となり、正しいファイル名が付与されない
【問題】分割処理とリネーム処理が適切に連携していない
【影響】要件定義通りのファイル名が生成されない
```

---

## 【修正要件詳細】

### 1. **分割判定ロジックの実装**

#### 分割対象の厳格な定義
```
【分割が必要な書類の判定条件】
以下のファイル名パターンに対応する書類が含まれる場合のみ分割処理を実行：

■ 国税関連セット
- 0003_受信通知_YYMM（法人税申告受信通知）
- 0004_納付情報_YYMM（法人税納付情報）
- 3003_受信通知_YYMM（消費税申告受信通知）
- 3004_納付情報_YYMM（消費税納付情報）

■ 地方税関連セット
都道府県分：
- 1003_受信通知_YYMM（1番目都道府県）
- 1013_受信通知_YYMM（2番目都道府県）
- 1023_受信通知_YYMM（3番目都道府県）
- 1033_受信通知_YYMM（4番目都道府県）
- 1043_受信通知_YYMM（5番目都道府県）
- 1004_納付情報_YYMM（都道府県納付情報）

市町村分：
- 2003_受信通知_YYMM（1番目市町村）
- 2013_受信通知_YYMM（2番目市町村）
- 2023_受信通知_YYMM（3番目市町村）
- 2033_受信通知_YYMM（4番目市町村）
- 2043_受信通知_YYMM（5番目市町村）
- 2004_納付情報_YYMM（市町村納付情報）
```

#### セット判定の実装
```
【国税セット判定】
- 0003 + 0004 の組み合わせ（法人税）
- 3003 + 3004 の組み合わせ（消費税）

【地方税セット判定】
- 1003/1013/1023/1033/1043 + 1004 の組み合わせ（都道府県分）
- 2003/2013/2023/2033/2043 + 2004 の組み合わせ（市町村分）
```

### 2. **分割不要書類の明確化**

#### 単一処理対象書類
```
【分割不要（単一処理）書類一覧】
申告書類：
- 3001_消費税及び地方消費税申告書_YYMM
- 0001_法人税及び地方法人税申告書_YYMM
- 0000_納付税額一覧表_YYMM
- 0002_添付資料_YYMM（法人税関連）
- 3002_添付資料_YYMM（消費税関連）

都道府県・市町村申告書：
- 1001_[都道府県名]_法人都道府県民税・事業税・特別法人事業税_YYMM
- 2001_[都道府県名][市町村名]_法人市民税_YYMM

会計書類（5000番台）：
- 5001_決算書_YYMM
- 5002_総勘定元帳_YYMM
- 5003_補助元帳_YYMM
- 5004_残高試算表_YYMM
- 5005_仕訳帳_YYMM
- 5006_仕訳データ_YYMM.csv

固定資産関連書類（6000番台）：
- 6001_固定資産台帳_YYMM
- 6002_一括償却資産明細表_YYMM
- 6003_少額減価償却資産明細表_YYMM

税区分関連書類（7000番台）：
- 7001_勘定科目別税区分集計表_YYMM
- 7002_税区分集計表_YYMM
```

### 3. **2段階処理システムの設計**

#### 処理フロー
```
【Stage 1: 分割判定・実行】
1. アップロードファイルのOCR実行
2. 分割対象キーワード検出
   - 判定キーワード：「税目」「種目」「法人税申告書」「消費税申告書」
   - 受信通知パターン：「申告受付完了通知」「受信通知」
   - 納付情報パターン：「納付情報発行結果」「納付区分番号通知」
3. 分割対象判定結果による処理分岐
   - 分割対象の場合：ページ単位分割実行 → Stage 2へ
   - 分割不要の場合：Stage 2へ直接移行

【Stage 2: リネーム処理】
1. 分割済み個別ファイルまたは元ファイルを対象
2. 各ファイルのキーワード判定実行（優先度順）
3. 手入力された都道府県・市町村情報の適用
4. 要件定義に基づくファイル名生成
5. リネーム実行
6. 処理結果ログ出力
```

#### 分割境界の判定アルゴリズム
```python
# 実装例
def detect_split_boundaries(pdf_pages, ocr_results):
    boundaries = []
    for i, page_text in enumerate(ocr_results):
        # 新しい書類の開始を示すキーワード検出
        if any(keyword in page_text for keyword in [
            '税務署長', '都道府県知事', '市町村長',
            '申告受付完了通知', '納付情報発行結果'
        ]):
            boundaries.append(i)
    return boundaries
```

### 4. **ファイル名生成ロジックの修正**

#### 分割後ファイル名の適正化
```
【問題の解決方針】
現状：分割後 → "ファイル名_コピー.pdf" → リネーム失敗
修正：分割後 → 一時ファイル名 → 判定結果による正式ファイル名付与

【実装方法】
1. 分割時は一時ファイル名（temp_001.pdf, temp_002.pdf等）を使用
2. 各一時ファイルに対してキーワード判定実行
3. 判定結果 + 手入力情報 → 最終ファイル名生成
4. 一時ファイルを最終ファイル名でリネーム
5. 処理完了後、一時ファイルを削除
```

---

## 【実装仕様】

### 1. **分割判定の実装**

#### キーワード検出ロジック
```python
# 分割対象判定キーワード
SPLIT_KEYWORDS = {
    'receipt_notice': ['申告受付完了通知', '受信通知'],
    'payment_info': ['納付情報発行結果', '納付区分番号通知'],
    'tax_types': ['法人税申告書', '消費税申告書', '法人都道府県民税']
}

def should_split_pdf(ocr_text):
    split_indicators = 0
    for category, keywords in SPLIT_KEYWORDS.items():
        for keyword in keywords:
            if keyword in ocr_text:
                split_indicators += 1
    
    # 2つ以上の異なる書類種別が検出された場合は分割対象
    return split_indicators >= 2
```

### 2. **分割処理の実装**

#### ページ分割ロジック
```python
def split_pdf_by_boundaries(pdf_path, boundaries):
    temp_files = []
    pdf_reader = PdfReader(pdf_path)
    
    for i, start_page in enumerate(boundaries):
        end_page = boundaries[i+1] if i+1 < len(boundaries) else len(pdf_reader.pages)
        
        pdf_writer = PdfWriter()
        for page_num in range(start_page, end_page):
            pdf_writer.add_page(pdf_reader.pages[page_num])
        
        temp_filename = f"temp_{i+1:03d}.pdf"
        with open(temp_filename, 'wb') as output_file:
            pdf_writer.write(output_file)
        
        temp_files.append(temp_filename)
    
    return temp_files
```

### 3. **リネーム処理の修正**

#### 最終ファイル名生成
```python
def generate_final_filename(temp_file, user_inputs, yymm):
    ocr_text = perform_ocr(temp_file)
    document_type = classify_document(ocr_text)
    
    if document_type in ['prefecture_tax', 'municipal_tax']:
        # 都道府県・市町村情報を使用
        location_info = get_location_from_inputs(user_inputs, document_type)
        return f"{document_type}_{location_info}_{yymm}.pdf"
    else:
        # 標準パターン
        return f"{document_type}_{yymm}.pdf"
```

---

## 【テストケース】

### 1. **分割対象の正常系**
```
【入力】法人税受信通知 + 法人税納付情報 + 消費税受信通知 + 消費税納付情報の複合PDF
【期待結果】
- 0003_受信通知_YYMM.pdf
- 0004_納付情報_YYMM.pdf  
- 3003_受信通知_YYMM.pdf
- 3004_納付情報_YYMM.pdf
```

### 2. **分割不要の正常系**
```
【入力】消費税申告書の単一PDF
【期待結果】
- 3001_消費税及び地方消費税申告書_YYMM.pdf（分割処理なし）
```

### 3. **複数都道府県・市町村の分割**
```
【入力】東京都 + 大阪府大阪市 + 福岡県福岡市の受信通知・納付情報セット
【期待結果】
- 1003_受信通知_YYMM.pdf（東京都）
- 1013_受信通知_YYMM.pdf（大阪府）
- 1023_受信通知_YYMM.pdf（福岡県）
- 2003_受信通知_YYMM.pdf（大阪市）
- 2013_受信通知_YYMM.pdf（福岡市）
- 1004_納付情報_YYMM.pdf
- 2004_納付情報_YYMM.pdf
```

---

## 【エラーハンドリング】

### 1. **分割判定エラー**
```
【ケース】分割対象キーワードが部分的にしか検出されない
【対応】ユーザーに手動判定を促すアラート表示

【ケース】OCR読み取り精度が低い
【対応】再処理オプションまたは手動分類モードへの切り替え
```

### 2. **分割処理エラー**
```
【ケース】PDF分割時のファイル破損
【対応】元ファイルのバックアップ保持、エラー通知

【ケース】一時ファイル作成失敗
【対応】ディスク容量確認、一時フォルダの権限確認
```

### 3. **リネーム処理エラー**
```
【ケース】同名ファイルの存在
【対応】自動連番付与（_001, _002等）

【ケース】ファイル名に使用不可文字が含まれる
【対応】自動文字置換（置換ルールの設定）
```

---

## 【期待する成果】

### 成果物
1. **正確な分割判定**: 分割対象・不要の判定精度99%以上
2. **適切な分割処理**: セット書類の正確な分割とファイル生成
3. **正しいリネーム**: 要件定義通りのファイル名付与率95%以上
4. **処理の可視化**: 分割・リネーム処理の詳細ログ出力

### 品質指標
- 分割判定精度: 99%以上
- リネーム成功率: 95%以上  
- 処理速度: 分割処理による遅延を最小限に抑制
- エラー処理: 全エラーパターンの適切な回復処理

---

## 【実装優先順位】

### Phase 1: 分割判定ロジック（1週間）
1. 分割対象キーワード検出エンジンの実装
2. セット判定アルゴリズムの構築
3. 分割不要書類の判定ロジック

### Phase 2: 分割処理機能（1-2週間）
1. PDF分割アルゴリズムの実装
2. 一時ファイル管理システム
3. 分割境界検出の精度向上

### Phase 3: リネーム処理の修正（1週間）
1. 2段階処理システムの実装
2. 最終ファイル名生成ロジック
3. エラーハンドリングの強化

### Phase 4: 統合テスト（1週間）
1. 全パターンの動作検証
2. パフォーマンステスト
3. ユーザビリティ確認

---

## 【制約条件】

### 技術制約
- 現行のPDF処理ライブラリを継続使用
- OCRエンジン（Tesseract）の性能範囲内での実装
- 一時ファイル用のディスク容量確保

### 運用制約
- 既存処理への影響を最小限に抑制
- 処理時間の大幅な増加を避ける
- ユーザーインターフェースの大幅変更を避ける

**GitHub Issue化および段階的実装により、確実な品質向上を図ります。**