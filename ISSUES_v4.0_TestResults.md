# 税務書類リネームシステム v4.0 テスト結果修正点レポート

## 📅 テスト実行日時
**2025年8月20日 02:12頃 - v4.0最終版テスト**

## ❌ 発見された修正点（3項目）

---

### 修正点①：国税受信通知一式の分割処理未実装
**現状**: 4枚+空白5枚のファイルが `0001_法人税及び地方法人税申告書_2508` として一括処理
**問題**: PDF分割機能が全く動作していない
**要求**: 以下4つに自動分割する機能の実装

```
期待する分割結果:
- 3003_受信通知_消費税_YYMM.pdf
- 3004_納付情報_消費税_YYMM.pdf  
- 0003_受信通知_法人税_YYMM.pdf
- 0004_納付情報_法人税_YYMM.pdf
```

**技術的課題**: 
- PyMuPDFを使用した複数書類の自動認識が未完成
- 空白ページの除去ロジックが必要
- 書類境界の正確な検出が必要

---

### 修正点②：自治体OCR認識と連番処理の完全失敗
**現状**: 自治体認識が全てNoneになっている
**問題**: 
- 「○○市長」「○○県」等のキーワードをPDF1ページ目から読み取れていない
- 手動入力セットとのマッチング処理が全く動作していない
- 結果的に連番が全く機能していない

**要求仕様**:
```
OCR処理フロー強化:
1. PDF 1ページ目の中央上部を重点的にOCR処理
2. 「○○県知事」「○○市長」「○○都」等の行政機関名を確実に抽出
3. 手動入力セット1~5と高精度マッチング
4. マッチした順序で連番付与（1001→1011→1021...）
```

**技術的要求**:
- OCR処理範囲の正確な座標指定
- 画像前処理による認識精度向上
- 手動入力との柔軟なマッチングアルゴリズム
- デバッグ用のOCR結果表示機能

---

### 修正点③：地方税受信通知一式の分割・リネーム処理エラー
**現状**: 分割処理が不完全で、一部のファイルが結合されている
- 存在するファイル: `1004_納付情報_YYMM`、`2004_納付情報_YYMM`のみ
- 不足しているファイル: 受信通知系が全て欠落

**要求する正しい分割結果**:
```
都道府県関連（1ページごとに分割）:
- 1003_受信通知_都道府県_YYMM.pdf（1番目）
- 1013_受信通知_都道府県_YYMM.pdf（2番目）  
- 1023_受信通知_都道府県_YYMM.pdf（3番目）
- 1033_受信通知_都道府県_YYMM.pdf（4番目）
- 1043_受信通知_都道府県_YYMM.pdf（5番目）
- 1053_受信通知_都道府県_YYMM.pdf（6番目）
- 1004_納付情報_都道府県_YYMM.pdf

市町村関連（1ページごとに分割）:
- 2003_受信通知_市町村_YYMM.pdf（1番目）
- 2013_受信通知_市町村_YYMM.pdf（2番目）
- 2023_受信通知_市町村_YYMM.pdf（3番目）
- 2033_受信通知_市町村_YYMM.pdf（4番目）
- 2043_受信通知_市町村_YYMM.pdf（5番目）
- 2004_納付情報_市町村_YYMM.pdf
```

**技術的要求**:
- **1ページごと分割**: 受信通知は必ず1ページずつ個別ファイル化
- **連番ルール**: 都道府県(1003, 1013, 1023...)、市町村(2003, 2013, 2023...)
- **内容判定**: ページ内容による受信通知・納付情報の正確な分類
- **自動ページ数検出**: 可変ページ数への対応

---

## 🎯 v4.1開発方針

### 緊急修正項目（最高優先度）
1. **PDF分割エンジンの完全再実装**
   - 国税受信通知一式の4分割機能
   - 地方税受信通知一式の1ページごと分割機能
   - 空白ページ除去機能

2. **OCR・自治体認識エンジンの強化**
   - PDF座標指定によるOCR処理
   - 認識精度向上のための画像前処理
   - デバッグ用認識結果表示

3. **分割処理の品質保証**
   - 1ページごと分割の確実な実行
   - 分割後ファイルの命名規則統一
   - 分割失敗時のエラーハンドリング

### 技術実装要件
- **PyMuPDF**: 高度なPDF分割・ページ操作
- **Tesseract**: 座標指定OCR処理
- **PIL**: 画像前処理・品質向上
- **デバッグ機能**: OCR結果・分割結果の詳細表示

---

## 📊 優先度

### 最高優先度（機能障害）
1. **修正点①**: 国税受信通知分割処理（完全未実装）
2. **修正点②**: 自治体OCR認識（完全機能不全）
3. **修正点③**: 地方税受信通知分割処理（部分的機能不全）

### 品質要求
- **分割成功率**: 95%以上
- **OCR認識率**: 90%以上（明確な文字の場合）
- **自治体マッチング率**: 85%以上

---

## 🔧 技術的検討事項

### PDF分割アルゴリズム改善
```python
def split_pdf_by_page(pdf_path: str, page_ranges: List[Tuple[int, int]]) -> List[str]:
    """
    指定されたページ範囲でPDFを分割
    
    Args:
        pdf_path: 分割対象PDFパス
        page_ranges: [(start, end), ...] のページ範囲リスト
    
    Returns:
        分割後ファイルパスのリスト
    """
```

### OCR処理座標指定
```python
def extract_text_from_region(pdf_path: str, page: int, region: Tuple[int, int, int, int]) -> str:
    """
    PDF指定領域からテキストを抽出
    
    Args:
        pdf_path: PDFファイルパス
        page: ページ番号（0ベース）
        region: (x1, y1, x2, y2) 座標
    
    Returns:
        抽出されたテキスト
    """
```

---

## 📋 次回テスト項目
1. **国税受信通知分割**: 4ファイルへの正確な分割
2. **地方税受信通知分割**: 1ページごとの正確な分割
3. **自治体OCR認識**: 手動入力とのマッチング確認
4. **連番処理**: 正しい連番付与の確認
5. **分割ファイル命名**: 規則に従った正確な命名

---

## 📚 関連ドキュメント
- [REQUIREMENTS_v4.0.md](./REQUIREMENTS_v4.0.md) - v4.0要件定義
- [ISSUES_v3.0_TestResults.md](./ISSUES_v3.0_TestResults.md) - v3.0テスト結果
- [README.md](./README.md) - プロジェクト基本情報

## 🚀 次ステップ
1. PDF分割エンジンの完全再実装
2. OCR・自治体認識エンジンの強化
3. 統合テスト・品質保証
4. v4.1としてリリース

**最終目標**: 完全自動化された高精度PDF分割・自治体認識システムの実現