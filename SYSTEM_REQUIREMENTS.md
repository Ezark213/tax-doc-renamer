# 税務書類画像認識・分割・リネームシステム要件定義書

## 1. システム概要

税務署へ提出する各種申告書類のPDFを画像認識により自動分割し、書類種別に応じた統一ファイル名で自動リネームするシステムを構築する。

## 2. 手入力項目要件

複数の自治体への提出に対応するため、以下の項目を手入力する機能を設ける：

### 2.1 自治体情報入力

最大5か所まで入力可能な都道府県・市町村セット（全て任意）
- セット1：都道府県名 + 市町村名（任意）
- セット2：都道府県名 + 市町村名（任意）
- セット3：都道府県名 + 市町村名（任意）
- セット4：都道府県名 + 市町村名（任意）
- セット5：都道府県名 + 市町村名（任意）

### 2.2 入力仕様

- **都道府県名**: 各セットで都道府県を選択/入力
- **市町村名**: 各セットで市町村を選択/入力
- **東京都の場合**: 市町村欄の入力は不要（自動的に空欄扱い）
- **その他道府県の場合**: 市町村名の入力が必要
- **年月（YYMM形式）**: 対象年月を4桁で入力（例：2025年6月→2506）
- **連番規則**: 実際に入力された順番通りに連番を付与（1番目→1001/2001、2番目→1011/2011...）
- **東京都制約**: 東京都が入力されている場合は必ず1番目（セット1）に配置する必要があり、他の位置にある場合はエラー表示
- **空欄対応**: セット1が空でも他のセットに入力がある場合は、入力のあるセットから順次処理

### 2.3 入力制約

- **必須入力**: なし（全ての項目が任意入力）
- **任意入力**: 全ての都道府県名、市町村名、年月（YYMM）
- **柔軟対応**: 東京都のみ、単一県市のみの入力も可能

### 入力パターン例

1. **複数自治体**: セット1に東京都、セット2に福岡県福岡市、セット3に愛知県蒲郡市を入力  
   →結果：東京都→1001、福岡県→1011、福岡市→2001、愛知県→1021、蒲郡市→2011

2. **単一自治体（東京都）**: セット1に「東京都」入力  
   → 東京都→1001

3. **単一自治体（その他）**: セット1に「大阪府」「大阪市」入力  
   → 大阪府→1001、大阪市→2001

4. **複数県市**: セット1に「福岡県」「福岡市」、セット2に「愛知県」「名古屋市」入力  
   →結果：福岡県→1001、福岡市→2001、愛知県→1011、名古屋市→2011

## 3. リネーム規則

### 3.1 地方税関連書類（自動分割・自動リネーム対象）

#### 3.1.1 納付情報発行結果
- **法人住民税**: 2004_納付情報_YYMM.pdf
- **法人二税・特別税**: 1004_納付情報_YYMM.pdf

#### 3.1.2 申告受付完了通知
- **都道府県分**: 1001_[都道府県名]_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
  - 東京都：1001_東京都_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
  - 大阪府：1001_大阪府_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
  - その他県：1001_[県名]_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
- **市町村分**: 2003_受信通知_YYMM.pdf
- **注意事項**: 東京都のみに提出の場合、市町村分の受信通知は存在しない

### 3.2 国税関連書類（自動分割・自動リネーム対象）

#### 3.2.1 消費税関連
- **申告受信通知**: 3003_受信通知_YYMM.pdf
- **納付区分番号通知**: 3004_納付情報_YYMM.pdf

#### 3.2.2 法人税関連
- **申告受信通知**: 0003_受信通知_YYMM.pdf
- **納付区分番号通知**: 0004_納付情報_YYMM.pdf

### 3.3 申告書類（文書判定方式リネーム対象）

#### 3.3.1 納付税額一覧表
- **ファイル名**: 0000_納付税額一覧表_YYMM.pdf

#### 3.3.2 添付資料（法人税関連）
- **ファイル名**: 0002_添付資料_YYMM.pdf

#### 3.3.3 添付資料（消費税関連）
- **ファイル名**: 3002_添付資料_YYMM.pdf

#### 3.3.4 消費税申告書
- **ファイル名**: 3001_消費税及び地方消費税申告書_YYMM.pdf

#### 3.3.5 法人税申告書
- **ファイル名**: 0001_法人税及び地方法人税申告書_YYMM.pdf

#### 3.3.6 都道府県民税申告書
- **ファイル名**: 1001_[都道府県名]_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf

#### 3.3.7 市民税申告書
- **ファイル名**: 2001_[都道府県名][市町村名]_法人市民税_YYMM.pdf

### 3.4 会計書類（文書判定方式リネーム対象）

#### 3.4.1 基本会計書類（5000番台）

- **決算報告書**: 5001_決算書_YYMM.pdf
- **総勘定元帳**: 5002_総勘定元帳_YYMM.pdf
- **補助元帳**: 5003_補助元帳_YYMM.pdf
- **残高試算表**: 5004_残高試算表_YYMM.pdf
- **仕訳帳**: 5005_仕訳帳_YYMM.pdf
- **仕訳データ（csv）**: 5006_仕訳データ_YYMM.csv

#### 3.4.2 固定資産関連書類（6000番台）

- **固定資産台帳**: 6001_固定資産台帳_YYMM.pdf
- **一括償却資産明細表**: 6002_一括償却資産明細表_YYMM.pdf
- **少額減価償却資産明細**: 6003_少額減価償却資産明細表_YYMM.pdf

#### 3.4.3 税区分関連書類（7000番台）

- **勘定科目別税区分集計表**: 7001_勘定科目別税区分集計表_YYMM.pdf
- **税区分集計表**: 7002_税区分集計表_YYMM.pdf

## 4. 複数書類対応要件

同一種別の書類が複数存在する場合、以下の連番規則を適用する：

### 4.1 都道府県民税申告書（複数都道府県）

入力順での連番規則：
- 1番目に入力された都道府県：1001_[都道府県名]_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
- 2番目に入力された都道府県：1011_[都道府県名]_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
- 3番目に入力された都道府県：1021_[都道府県名]_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
- 4番目に入力された都道府県：1031_[都道府県名]_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
- 5番目に入力された都道府県：1041_[都道府県名]_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf

### 4.2 市民税申告書（複数市町村）

入力順での連番規則：
- 1番目に入力された市町村：2001_[都道府県名][市町村名]_法人市民税_YYMM.pdf
- 2番目に入力された市町村：2011_[都道府県名][市町村名]_法人市民税_YYMM.pdf
- 3番目に入力された市町村：2021_[都道府県名][市町村名]_法人市民税_YYMM.pdf
- 4番目に入力された市町村：2031_[都道府県名][市町村名]_法人市民税_YYMM.pdf
- 5番目に入力された市町村：2041_[都道府県名][市町村名]_法人市民税_YYMM.pdf

### 4.3 受信通知（複数市町村）

入力順での連番規則：
- 1番目に入力された市町村：2003_受信通知_YYMM.pdf
- 2番目に入力された市町村：2013_受信通知_YYMM.pdf
- 3番目に入力された市町村：2023_受信通知_YYMM.pdf
- 4番目に入力された市町村：2033_受信通知_YYMM.pdf
- 5番目に入力された市町村：2043_受信通知_YYMM.pdf

**注意事項**：
- 入力された順番通りに連番を付与（1番目→1001/2001、2番目→1011/2011）
- セット1が空でも他のセットに入力がある場合は、入力のあるセットから順次処理
- 東京都の場合は市町村欄が空でも都道府県分のみ処理
- 市町村が入力されていない場合は2000番台のファイルは生成しない
- 東京都が1番目以外に入力された場合はエラー表示
- 東京都には市町村分の受信通知は存在しないため、その他都道府県の市町村のみが対象

## 5. 処理フロー要件

### 5.1 自動分割・リネーム処理

1. 複数ページPDFを読み込み
2. 空白ページ・不要ページの自動検出・除外
3. 書類種別を自動判定
4. ページ単位で分割
5. 判定結果に基づく自動リネーム実行

### 5.2 文書判定方式リネーム処理

1. 単一PDFファイルを読み込み
2. 空白ページ・不要ページの自動検出・除外
3. OCR等で文書内容を分析
4. 書類種別判定処理
5. 手入力された都道府県名・市町村名・年月情報を取得（全項目任意）
6. 入力情報の有無確認（未入力の場合は文書内容のみでリネーム）
7. 判定結果とユーザー入力を組み合わせてリネーム実行

### 5.3 空白ページ除外処理

#### 除外対象ページの判定条件
- 実質的な文字情報が含まれていないページ
- 「メッセージ Page X of Y」のみが記載されたページ
- ページ番号やヘッダー情報のみのページ
- OCR処理後のテキスト量が設定閾値以下のページ

#### 除外処理の実行
- 除外対象ページは分割処理から自動的に除外
- 除外されたページの情報をログに記録
- ユーザーに除外ページ数と理由を通知

## 6. エラー処理要件

### 6.1 判定エラー
- 複数の書類種別に該当する場合：優先度に基づく自動選択またはユーザー確認
- 判定不能な書類：手動分類を促すアラート表示
- OCR読み取りエラー：再処理オプション提供

### 6.2 入力エラー
- 東京都位置エラー：東京都が1番目以外のセットに入力された場合、「東京都は1番目に入力してください」のエラーメッセージを表示
- 年月形式エラー：YYMM形式以外が入力された場合のエラーメッセージ表示

### 6.3 ファイル名重複
- 同一ファイル名が既存の場合：自動連番付与
- 連番上限到達時：エラーメッセージ表示

### 6.4 空白ページ処理エラー
- 全ページが空白と判定された場合：エラーメッセージ表示とファイル確認促進
- 空白ページ除外後に有効ページが0件の場合：処理中止とユーザー通知
- 空白ページ判定の誤検出：手動確認オプション提供

## 7. 運用要件

### 7.1 ファイル命名規則
- 都道府県名・市町村名は正式名称を使用
- 年月（YYMM）は全てのリネーム後ファイルに必須付与
- 同一処理内で複数書類がある場合は自動連番処理

### 7.2 品質保証
- 処理結果の確認画面表示
- リネーム前後のファイル名対応表出力
- 空白ページ除外結果のレポート出力
- 処理ログの保存

### 7.3 拡張性
- 新しい書類種別の追加に対応
- 文書判定ルールの設定変更機能
- ファイル命名規則のカスタマイズ機能
- 空白ページ判定閾値の調整機能