# 税務書類リネームシステム v4.2 修正仕様書

## 現状の問題点と修正方針

### 📋 問題点一覧

#### ❌ 問題① 少額減価償却資産明細表の不要分割
**現状**: 分割不要なのに分割されている  
**期待**: `6003_少額減価償却資産明細表_YYMM.pdf`として単一ファイル処理

#### ❌ 問題② 一括償却資産明細表の不要分割  
**現状**: 分割不要なのに分割されている  
**期待**: `6002_一括償却資産明細表_YYMM.pdf`として単一ファイル処理

#### ❌ 問題③ 法人税申告書の誤判定
**現状**: `5001_決算書_YYMM.pdf`と誤判定  
**期待**: `0001_法人税及び地方法人税申告書_YYMM.pdf`

#### ❌ 問題④ 分割対象書類の処理不備
**現状**: 分割されずコピー後リネーム  
**期待**: 1ページごと分割（空白ページ除去）→リネーム

#### ❌ 問題⑤ 都道府県・市町村の申告書判定不備
**現状**: `1001,1011,1021,2001,2011`等が不明判定  
**期待**: 地域自動判定による正確なリネーム

---

## ✅ 修正仕様

### 1. 分割除外リスト実装

```python
# 分割不要書類パターン
NO_SPLIT_PATTERNS = [
    '少額減価償却', '少額', 
    '一括償却資産明細', '一括償却',
    '固定資産台帳',
    '決算書', '貸借対照表', '損益計算書',
    '総勘定元帳', '補助元帳', '仕訳帳'
]
```

### 2. 1ページ分割アルゴリズム改善

```python
def split_pdf_by_page_with_blank_removal(pdf_path):
    """1ページごと分割（空白ページ自動除去）"""
    doc = fitz.open(pdf_path)
    valid_pages = []
    
    for page_num in range(len(doc)):
        page = doc[page_num]
        text = page.get_text().strip()
        
        # 空白ページ判定（テキスト50文字未満は空白扱い）
        if len(text) >= 50:
            valid_pages.append(page_num)
    
    return create_split_files(doc, valid_pages)
```

### 3. 地域判定エンジン実装

#### 3.1 都道府県事務所パターン
```python
PREFECTURE_PATTERNS = {
    '東京都': ['東京都港都税事務所長', '東京都.*税事務所長'],
    '愛知県': ['愛知県東三河県税事務所長', '愛知県.*県税事務所長'],
    '福岡県': ['福岡県西福岡県税事務所長', '福岡県.*県税事務所長']
}
```

#### 3.2 市町村長パターン  
```python
CITY_PATTERNS = {
    '蒲郡市': ['蒲郡市長'],
    '福岡市': ['福岡市長']
}
```

#### 3.3 リネーミングルール
```python
def generate_regional_filename(prefecture, city, document_type, yymm):
    """地域別ファイル名生成"""
    
    # 都道府県申告書（10番台）
    if document_type == "都道府県申告":
        prefecture_code = get_prefecture_code(prefecture)  # 1001, 1011, 1021...
        return f"{prefecture_code}_{prefecture}_法人都道府県民税・事業税・特別法人事業税_{yymm}.pdf"
    
    # 市町村申告書（20番台）- 東京都は除外
    elif document_type == "市町村申告" and prefecture != "東京都":
        city_code = get_city_code(prefecture, city)  # 2001, 2011, 2021...
        return f"{city_code}_{prefecture}{city}_法人市民税_{yymm}.pdf"
    
    return None
```

### 4. コード番号マッピング

#### 4.1 都道府県コード（セット番号対応）
```python
PREFECTURE_CODES = {
    1: "1001",  # セット1 → 1001
    2: "1011",  # セット2 → 1011  
    3: "1021",  # セット3 → 1021
    4: "1031",  # セット4 → 1031
    5: "1041"   # セット5 → 1041
}
```

#### 4.2 市町村コード（セット番号対応）
```python
CITY_CODES = {
    1: "2001",  # セット1 → 2001（東京都は除外）
    2: "2011",  # セット2 → 2011
    3: "2021",  # セット3 → 2021  
    4: "2031",  # セット4 → 2031
    5: "2041"   # セット5 → 2041
}
```

### 5. 判定優先度の再調整

```python
# 最高優先度：地域判定（新規追加）
REGIONAL_PRIORITY_PATTERNS = {
    '都道府県申告': 'REGIONAL_PREFECTURE_CODE',
    '市町村申告': 'REGIONAL_CITY_CODE'
}

# 高優先度：具体的書類名
HIGH_PRIORITY_PATTERNS = {
    '法人税申告': '0001_法人税及び地方法人税申告書_{yymm}.pdf',  # 優先度UP
    '内国法人の確定申告': '0001_法人税及び地方法人税申告書_{yymm}.pdf',
    # ...既存パターン
}
```

---

## 🔄 実装手順

### Phase 1: 分割制御修正
1. `NO_SPLIT_PATTERNS`による分割除外実装
2. 空白ページ除去機能追加
3. 1ページ分割の改善

### Phase 2: 地域判定エンジン
1. OCRテキストからの事務所長パターン検出
2. セット設定との対応関係構築
3. 地域別コード生成機能

### Phase 3: 判定優先度再調整
1. 地域判定を最優先に変更
2. 法人税申告書の判定精度向上
3. 決算書との分離強化

### Phase 4: 統合テスト
1. 全パターンでの動作確認
2. 分割・地域判定・リネームの連携テスト
3. エラーハンドリング検証

---

## 📝 期待する成果

### ✅ 修正後の動作例

**入力**: 地方税.pdf（7ページ）
1. 空白ページ除去 → 有効5ページ
2. 1ページごと分割 → 5個のPDFファイル
3. 各ページの地域判定実行
4. セット設定と照合してリネーム

**出力例**:
```
1001_東京都_法人都道府県民税・事業税・特別法人事業税_2508.pdf
1011_愛知県_法人都道府県民税・事業税・特別法人事業税_2508.pdf  
1021_福岡県_法人都道府県民税・事業税・特別法人事業税_2508.pdf
2011_愛知県蒲郡市_法人市民税_2508.pdf
2021_福岡県福岡市_法人市民税_2508.pdf
```

### 🎯 品質目標
- **分割精度**: 不要分割0%
- **地域判定精度**: 95%以上
- **ファイル名正確性**: 98%以上
- **処理速度**: 現行維持

---

## 🚨 重要な制約

1. **東京都特別ルール**: 市町村申告書は生成しない
2. **セット設定必須**: 都道府県・市町村の事前設定が判定の前提
3. **OCR依存**: 事務所長等の文言検出精度に依存
4. **既存機能維持**: 他の書類処理に影響を与えない

---

## 📂 次のアクション

1. ✅ 仕様書作成完了
2. 🔄 分割制御ロジック修正
3. 🔄 地域判定エンジン実装
4. 🔄 統合テスト実施
5. 🔄 v4.2リリース

この仕様書に基づいて、段階的に修正を実装していきます。