# 税務書類リネームシステム v3.0 テスト結果修正点レポート

## 📅 テスト実行日時
**2025年8月19日 15:30頃 - v3.0完全版テスト**

## ❌ 発見された修正点（7項目）

### 修正点①：国税受信通知一式の分割処理未実装
**現状**: 4枚+空白5枚のファイルが `0001_法人税及び地方法人税申告書_2508` として一括処理
**問題**: PDF分割機能が動作していない
**要求**: 以下4つに自動分割する機能の実装

```
期待する分割結果:
- 3003_受信通知_消費税_YYMM.pdf
- 3004_納付情報_消費税_YYMM.pdf  
- 0003_受信通知_法人税_YYMM.pdf
- 0004_納付情報_法人税_YYMM.pdf
```

**技術的課題**: PyMuPDFを使用した複数書類の自動認識・分割ロジックが未完成

---

### 修正点②：添付資料の誤分類
**現状**: `3002_添付資料_YYMM` となるべきものが `7001_勘定科目別税区分集計表_2508` と誤分類
**原因**: キーワード検出の優先度設定に問題
**要求**: 添付資料の正確な分類ロジック

**キーワード候補**:
- 「添付資料」「資料」「参考資料」
- 消費税関連の資料識別

---

### 修正点③：法人税申告書の誤分類  
**現状**: `0001_法人税及び地方法人税申告書_2508` となるべきものが `0002_添付資料_法人税_2508` と誤分類
**原因**: 法人税申告書の識別キーワードが弱い
**要求**: より精密な法人税申告書判定

**キーワード候補**:
- 「法人税申告書」「内国法人の確定申告」「法人税及び地方法人税」
- 申告書第一表などの特定表記

---

### 修正点④：自治体数の認識エラー
**現状**: 詳細不明（県2か所と都に出すべき10の意味が不明確）
**推測**: 都道府県・市町村の件数認識に問題
**要求**: 正確な自治体数の把握と処理

---

### 修正点⑤：自治体OCR認識とマッチング機能の完全失敗
**現状**: 連番処理が全く機能していない
**問題**: 
- 「○○市長」「○○県」等のキーワードをPDF1枚目から読み取れていない
- 手動入力セットとのマッチング処理が動作していない
- 結果的に全て同じ連番になっている

**要求仕様**:
```
OCR処理フロー:
1. PDF 1ページ目の中央上部を重点的にOCR処理
2. 「○○県知事」「○○市長」「○○都」等の行政機関名を抽出
3. 手動入力セット1~5と文字列マッチング
4. マッチした順序で連番付与（1001→1011→1021...）
```

**技術的要求**:
- OCR精度向上（特定領域の重点処理）
- 文字列マッチングアルゴリズムの実装
- 手動入力との照合処理強化

---

### 修正点⑥：地方税受信通知一式の分割・リネーム処理エラー
**現状**: 分割は実行されているがリネームが間違っている
- 期待: 7種類の個別ファイル
- 実際: `1001_東京都`、`1011_愛知県`、`1021_福岡県` の3つのみ

**要求する正しい分割結果**:
```
- 1003_受信通知_都道府県_YYMM.pdf（1番目）
- 1013_受信通知_都道府県_YYMM.pdf（2番目）  
- 1004_納付情報_都道府県_YYMM.pdf
- 2003_受信通知_市町村_YYMM.pdf（1番目）
- 2013_受信通知_市町村_YYMM.pdf（2番目）
- 2023_受信通知_市町村_YYMM.pdf（3番目）
- 2004_納付情報_市町村_YYMM.pdf
```

**技術的課題**:
- PDF内容による書類種別の正確な判定
- 都道府県/市町村の自動判別
- 連番との組み合わせ処理

---

### 修正点⑧：CSVファイル読み込み失敗
**現状**: 仕訳CSVファイルが読み込めない
**エラー**: pandas処理でのエラーが発生している可能性
**要求**: CSV処理の完全対応

**技術的要求**:
- CSVファイル形式の詳細解析
- pandas読み込み時のエラーハンドリング強化
- CSV内容からの書類種別判定ロジック

---

### 修正点⑨：ドラッグ&ドロップ機能未実装（追加要求）
**現状**: ファイル選択がボタンクリックのみ
**要求**: ドラッグ&ドロップによるファイル選択機能
**UI改善**: より直感的なファイル選択方法

---

## 🎯 v4.0開発方針

### ゼロベース再構築アプローチ
1. **要件定義の再整理**: README.mdとの整合性確保
2. **アーキテクチャ再設計**: PDF分割・OCR・マッチング処理の分離
3. **テスト駆動開発**: 各機能の単体テスト実装
4. **段階的実装**: 機能別の段階的開発・テスト

### 技術スタック見直し
- **PDF処理**: PyMuPDF（高度分割処理）
- **OCR処理**: Tesseract（領域指定処理強化）  
- **CSV処理**: pandas（エラーハンドリング強化）
- **UI処理**: tkinter（ドラッグ&ドロップ対応）
- **ファイル処理**: pathlib（モダンなパス処理）

### 品質保証
- **ユニットテスト**: 各機能の個別テスト
- **統合テスト**: 実ファイルでの動作確認
- **回帰テスト**: 既存機能の動作保証

---

## 📊 優先度

### 最高優先度（機能修正）
1. **修正点⑤**: 自治体OCR認識とマッチング（根幹機能）
2. **修正点①**: 国税受信通知分割処理（重要機能）
3. **修正点⑥**: 地方税受信通知分割・リネーム（重要機能）

### 高優先度（分類修正）
4. **修正点②**: 添付資料の正確な分類
5. **修正点③**: 法人税申告書の正確な分類
6. **修正点⑦**: CSV読み込み対応

### 中優先度（UI改善）  
7. **修正点⑨**: ドラッグ&ドロップ機能
8. **修正点④**: 自治体数認識の詳細確認

---

## 📚 関連ドキュメント
- [README.md](./README.md) - 基本仕様
- [REQUIREMENTS_v3.0.md](./REQUIREMENTS_v3.0.md) - v3.0要件定義  
- [ISSUES_v2.9.md](./ISSUES_v2.9.md) - v2.9修正点
- [tax_document_renamer_v3.py](./tax_document_renamer_v3.py) - 現行実装

## 🚀 次ステップ
1. v4.0要件定義書の作成
2. アーキテクチャ設計文書の作成  
3. ゼロベース実装の開始
4. 段階的テスト・検証