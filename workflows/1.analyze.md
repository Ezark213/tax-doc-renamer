# 税務書類リネーマーシステム - 分析フェーズ v5.3.5-ui-robust

## 概要
税務書類リネーマーシステムの機能追加・バグ修正における体系的分析手順書

## 1. システム設計書調査

### 対象ドキュメント
```bash
# 既存ドキュメント検索
find . -name "*.md" -o -name "*.txt" -o -name "*.rst" | grep -E "(README|docs|spec|design)"

# 分析対象
- README.md (システム概要)
- tmp/enterprise_implementation_plan.md (エンタープライズ実装計画)
- V534_IMPLEMENTATION_SUMMARY.md (実装サマリー)
- BUNDLE_AUTO_SPLIT_v5_2_README.md (Bundle分割仕様)
- QUICK_START_v5_2.md (クイックスタート)
```

### 重要システム要件
- **UI YYMM強制適用**: 6001,6002,6003,0000コードでUI値必須
- **Bundle分割処理**: 国税・地方税受信通知の自動分割
- **RunConfig中央管理**: UI値の単一ソース管理
- **JobContext統合**: 処理ライフサイクル一元管理

## 2. OSS調査・ベストプラクティス研究

### バグ修正時の参考OSS
```yaml
参考プロジェクト:
  - PyMuPDF: PDF処理・テキスト抽出
  - pypdf: PDF分割・結合処理
  - tkinter: GUI実装パターン
  - pytest: テスト実装手法
```

### 機能追加時の参考実装
```yaml
実装パターン:
  - 文書分類システム: scikit-learn, transformers
  - ファイルリネーム: pathlib, shutil
  - 設定管理: dataclasses, pydantic
  - ログ監査: logging, structlog
```

## 3. コードベース分析 (Claude Code活用)

### 主要コンポーネント分析
```python
# 分析対象ファイル
main_components = {
    "main.py": "メインアプリケーション (1,798行)",
    "core/classification_v5.py": "分類エンジン (106KB)",
    "helpers/yymm_policy.py": "YYMM ポリシーシステム",
    "helpers/run_config.py": "中央設定管理",
    "helpers/job_context.py": "ジョブ管理",
    "core/pdf_processor.py": "Bundle分割処理"
}
```

### 依存関係分析
```bash
# 依存関係マップ生成
python -m pip freeze > requirements.txt
python -c "
import ast
import sys
from pathlib import Path

def analyze_imports(file_path):
    with open(file_path, 'r', encoding='utf-8') as f:
        try:
            tree = ast.parse(f.read())
            for node in ast.walk(tree):
                if isinstance(node, ast.Import):
                    for alias in node.names:
                        print(f'{file_path}: import {alias.name}')
                elif isinstance(node, ast.ImportFrom):
                    print(f'{file_path}: from {node.module} import ...')
        except:
            pass

for py_file in Path('.').rglob('*.py'):
    if not str(py_file).startswith('.'):
        analyze_imports(py_file)
"
```

### エラーパターン分析
```python
# 過去のエラーログ分析
error_patterns = {
    "YYMM関連": [
        "resolve_yymm_by_policy() got an unexpected keyword argument 'detected'",
        "[FATAL][YYMM] UI value required but missing for 6001"
    ],
    "Bundle処理": [
        "processing_callback error",
        "Bundle detection failed"
    ],
    "UI関連": [
        "GUI initialization error",
        "Settings propagation failed"
    ]
}
```

## 4. 技術負債・パフォーマンス分析

### コードメトリクス
```bash
# ファイルサイズ分析
find . -name "*.py" -exec wc -l {} + | sort -nr

# 複雑度分析 (McCabe)
python -m mccabe --min 10 **/*.py

# 重複コード検出
python -m pycodestyle **/*.py
```

### セキュリティ分析
```yaml
チェック項目:
  - ファイルパス操作: pathlib使用確認
  - 入力検証: UI値・ファイル名検証
  - エラーハンドリング: 適切な例外処理
  - ログセキュリティ: 機密情報出力確認
```

## 5. 分析結果出力

### 自動分析レポート生成
```python
import datetime
import json

def generate_analysis_report():
    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    report_path = f"tmp/auto_analysis_{timestamp}.md"
    
    analysis_data = {
        "system_overview": {
            "version": "v5.3.5-ui-robust",
            "architecture": "モノリシック→モジュラー移行中",
            "key_features": [
                "UI YYMM強制適用システム",
                "Bundle分割処理",
                "RunConfig中央管理",
                "JobContext統合"
            ]
        },
        "technical_debt": [
            "main.py肥大化 (1,798行)",
            "classification_v5.py巨大化 (106KB)",
            "責任境界不明確",
            "UI・ビジネス・データ層混在"
        ],
        "critical_paths": [
            "UI値→RunConfig→JobContext→ポリシー適用",
            "Bundle検出→分割→コールバック→リネーム",
            "エラーハンドリング→ログ出力→UI表示"
        ],
        "recommended_approaches": [
            "責任分離パターン適用",
            "依存性注入導入",
            "イベント駆動アーキテクチャ",
            "包括的テストカバレッジ"
        ]
    }
    
    with open(report_path, 'w', encoding='utf-8') as f:
        f.write(f"# 税務書類リネーマー自動分析レポート\n")
        f.write(f"生成日時: {timestamp}\n\n")
        f.write(json.dumps(analysis_data, ensure_ascii=False, indent=2))
    
    return report_path
```

## 6. 分析完了チェックリスト

### 必須確認事項
- [ ] システム設計書完全調査
- [ ] OSS参考実装3件以上調査
- [ ] 主要コンポーネント依存関係マップ作成
- [ ] エラーパターン・技術負債特定
- [ ] セキュリティ・パフォーマンス評価
- [ ] 分析レポート自動生成

### 品質基準
- [ ] 事実と推測の明確分離
- [ ] ライセンス互換性確認
- [ ] セキュリティ・コード品質評価
- [ ] コミュニティメンテナンス状況確認

## 7. 次フェーズへの引き継ぎ

### 計画フェーズへの入力
```yaml
分析結果サマリー:
  現状評価: "v5.3.5-ui-robust完成、エンタープライズ品質達成"
  主要課題: "アーキテクチャモダン化、技術負債解消"
  推奨アプローチ: "段階的リファクタリング、テスト強化"
  実装優先度: "高:セキュリティ, 中:パフォーマンス, 低:UI改善"
```

---

**分析モットー**: "Ultrathink. Don't hold back. give it your all！"  
**完了基準**: 全チェックリスト項目完了 + 分析レポート生成完了