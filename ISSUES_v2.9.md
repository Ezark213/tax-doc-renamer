# 税務書類リネームシステム v2.9 修正点レポート

## 📅 テスト実行日時
**2025年8月20日 00:12:31 - 00:12:32**

## ✅ 動作確認済み項目
- アプリケーションの正常起動 ✅
- PDFファイルの選択・読み込み ✅  
- OCR機能（Tesseract）正常動作 ✅
- タブ形式UI（ファイル選択・処理結果・開発者ログ）正常表示 ✅
- 基本的な書類種別判定 ✅
- 処理結果表示 ✅

## 📊 テスト結果サマリー
- **処理対象**: 22件のファイル
- **成功**: 21件
- **エラー**: 1件（CSVファイル処理失敗）
- **処理時間**: 約1秒

---

## 🔧 修正が必要な項目

### 修正点①：入力年月の優先順位
**現状**: OCRで画像認識した年月を使用  
**要求**: 手動入力値を最優先とする  
**例**: 手動入力「2508」→ 全ファイルの末尾を「2508」にする

```
現在: 3001_消費税申告書_2507.pdf（OCRで2507を抽出）
修正後: 3001_消費税申告書_2508.pdf（手動入力2508を使用）
```

### 修正点②：国税受信通知一式の分割処理
**現状**: 複数書類が1つのファイルとしてまとめて処理される  
**問題ファイル**: `3002_添付資料_消費税_2406.pdf`（4枚+空白5枚）  
**要求**: 以下4種類に自動分割

```
分割後:
- 3003_受信通知_YYMM.pdf
- 3004_納付情報_YYMM.pdf  
- 0003_受信通知_YYMM.pdf
- 0004_納付情報_YYMM.pdf
```

### 修正点③：税区分集計表の分類改善
**現状**: 両方とも `7001_税区分集計表` として処理  
**要求**: 以下のように明確に分類

```
現在: 
- 勘定科目別税区分集計表 → 7001_税区分集計表_2410.pdf
- 税区分集計表 → 7001_税区分集計表_2410.pdf

修正後:
- 勘定科目別税区分集計表 → 7001_勘定科目別税区分集計表_YYMM.pdf
- 税区分集計表 → 7002_税区分集計表_YYMM.pdf
```

### 修正点④：法人税申告書の誤分類
**現状**: `01_内国法人の確定申告(青色)` → `5002_総勘定元帳_2507.pdf`  
**要求**: `0001_法人税及び地方法人税申告書_YYMM.pdf`

**原因分析**: 「総勘定元帳」キーワードが誤って検出されている

### 修正点⑤：自治体別連番処理の強化
**現状**: 都道府県・市町村の連番が正しく機能していない  
**問題**: 全て同じ連番（1001, 2001）になっている

**要求仕様**:
```
都道府県申告書:
- 1番目: 1001_東京都_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf
- 2番目: 1011_愛知県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf  
- 3番目: 1021_福岡県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf

市町村申告書:
- 1番目: 2001_愛知県蒲郡市_法人市民税_YYMM.pdf
- 2番目: 2011_福岡県福岡市_法人市民税_YYMM.pdf
```

**改善方法**: OCRで「〇〇市長」「〇〇県知事」等のワードを1枚目中央上部から読み取り、手動入力セットと照合

### 修正点⑥：地方税受信通知一式の分割処理  
**現状**: 7枚が `2004_納付情報_2507.pdf` として一括処理  
**要求**: 以下7種類に自動分割

```
分割後:
- 1003_受信通知_YYMM.pdf
- 1013_受信通知_YYMM.pdf
- 1004_納付情報_YYMM.pdf
- 2003_受信通知_YYMM.pdf
- 2013_受信通知_YYMM.pdf
- 2023_受信通知_YYMM.pdf
- 2004_納付情報_YYMM.pdf
```

### 修正点⑦：CSVファイル対応
**現状**: CSVファイル処理でエラー発生  
**エラーファイル**: `仕訳帳_20250818_1018.csv`  
**要求**: CSVファイルも正常に処理・リネーム可能にする

---

## 🎯 優先順位

### 高優先度
1. **修正点①**: 入力年月優先（即座に修正可能）
2. **修正点④**: 法人税申告書の誤分類（キーワード調整）
3. **修正点⑦**: CSVファイル対応（拡張子対応）

### 中優先度  
4. **修正点③**: 税区分集計表の分類改善
5. **修正点⑤**: 自治体別連番処理

### 低優先度（大きな機能追加）
6. **修正点②**: 国税受信通知分割
7. **修正点⑥**: 地方税受信通知分割

---

## 📋 技術的検討事項

### PDF分割機能の実装
- **ライブラリ**: PyMuPDF (fitz) を使用
- **分割基準**: ページ内容のキーワード検出
- **ファイル出力**: 分割後の個別PDF生成

### OCR精度向上  
- **対象領域**: 1ページ目の中央上部に焦点
- **キーワード**: 「〇〇県知事」「〇〇市長」等の行政機関名
- **照合処理**: 手動入力セットとの自動マッチング

### CSVファイル処理
- **読み込み**: pandas または csv ライブラリ使用
- **判定基準**: ファイル名および内容から書類種別を判定
- **出力**: 同一命名規則でリネーム

---

## 🧪 次回テスト項目
1. 手動入力年月の優先確認
2. 法人税申告書の正しい分類
3. CSVファイルの正常処理
4. 自治体別連番の動作確認
5. 分割機能のテスト（実装後）

---

## 📚 関連ドキュメント
- [README.md](./README.md) - システム概要と基本仕様
- [requirements.txt](./requirements.txt) - 依存関係
- [tax_document_renamer.py](./tax_document_renamer.py) - メインアプリケーション