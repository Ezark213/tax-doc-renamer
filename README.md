# 税務書類リネームシステム v2.1

PDFファイルからテキストを自動抽出し、OCR機能により書類種別を判定して適切なファイル名にリネームするシステムです。

## 🚀 主な機能

### 📁 自動書類判定・リネーム
- **法人税関連書類**：申告書、受信通知、納付情報
- **地方税関連書類**：都道府県民税、市町村民税、各種納付情報
- **会計書類**：決算書、総勘定元帳、固定資産台帳、税区分集計表など
- **OCR対応**：スキャンされたPDFからも自動テキスト抽出

### 🏢 複数自治体対応
- **最大5つの自治体**を同時処理
- **連番自動付与**：入力順に1001→1011→1021→1031→1041
- **東京都特別処理**：市町村入力不要、必ず1番目配置

### 🖥️ タブ形式UI
- **📁 ファイル選択・設定タブ**：PDFファイル選択、自治体情報入力
- **📊 処理結果タブ**：リネーム結果の一覧表示
- **🔧 開発者ログタブ**：詳細な処理ログ、デバッグ情報

### 🎯 新機能（v2.1）
- **ドラッグ&ドロップ対応**：ファイルリストボックスに直接PDFを追加
- **自動タブ切り替え**：処理完了後、結果タブに自動移動
- **強化されたデバッグ機能**：抽出テキスト例、マッチキーワード表示
- **2001番台判定強化**：市町村申告書の認識精度向上
- **固定資産書類対応**：6002/6003番台書類の判定追加

## 📦 インストール・実行

### 方法1: 実行ファイル（推奨）
```
dist/TaxDocumentRenamer_v2.1_Tabbed.exe
```
をダウンロードして実行

### 方法2: Pythonから実行
```bash
# 必要なライブラリのインストール
pip install -r requirements.txt

# 実行
python tax_document_renamer.py
```

## 🎯 対応書類一覧

### 申告書類（0000番台）
| ファイル名 | 判定キーワード |
|------------|----------------|
| `0000_納付税額一覧表_YYMM.pdf` | 納付税額一覧表 |
| `0001_法人税申告書_YYMM.pdf` | 事業年度分の法人税申告書 |
| `0002_添付資料_法人税_YYMM.pdf` | 添付書類送付書、内国法人の確定申告 |
| `0003_受信通知_YYMM.pdf` | 種目 法人税及び地方法人税申告書 |
| `0004_納付情報_YYMM.pdf` | 税目 法人税及地方法人税 |

### 都道府県関連（1000番台）
| ファイル名 | 説明 |
|------------|------|
| `1001_東京都_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf` | 1番目都道府県 |
| `1011_愛知県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf` | 2番目都道府県 |
| `1021_福岡県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf` | 3番目都道府県 |
| `1031_XXX県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf` | 4番目都道府県 |
| `1041_XXX県_法人都道府県民税・事業税・特別法人事業税_YYMM.pdf` | 5番目都道府県 |
| `1004_納付情報_YYMM.pdf` | 法人二税・特別税納付情報 |

### 市町村関連（2000番台）
| ファイル名 | 説明 |
|------------|------|
| `2001_愛知県蒲郡市_法人市民税_YYMM.pdf` | 1番目市町村申告書 |
| `2011_福岡県福岡市_法人市民税_YYMM.pdf` | 2番目市町村申告書 |
| `2021_XXX県XXX市_法人市民税_YYMM.pdf` | 3番目市町村申告書 |
| `2031_XXX県XXX市_法人市民税_YYMM.pdf` | 4番目市町村申告書 |
| `2041_XXX県XXX市_法人市民税_YYMM.pdf` | 5番目市町村申告書 |
| `2003_受信通知_YYMM.pdf` | 1番目市町村受信通知 |
| `2013_受信通知_YYMM.pdf` | 2番目市町村受信通知 |
| `2023_受信通知_YYMM.pdf` | 3番目市町村受信通知 |
| `2033_受信通知_YYMM.pdf` | 4番目市町村受信通知 |
| `2043_受信通知_YYMM.pdf` | 5番目市町村受信通知 |
| `2004_納付情報_YYMM.pdf` | 法人住民税納付情報 |

### 消費税関連（3000番台）
| ファイル名 | 判定キーワード |
|------------|----------------|
| `3001_消費税申告書_YYMM.pdf` | この申告書による消費税の税額の計算 |
| `3002_添付資料_消費税_YYMM.pdf` | 添付書類送付書、消費税及び地方消費税 |
| `3003_受信通知_YYMM.pdf` | 種目 消費税申告書 |
| `3004_納付情報_YYMM.pdf` | 税目 消費税及地方消費税 |

### 会計書類（5000番台）
| ファイル名 | 判定キーワード |
|------------|----------------|
| `5001_決算書_YYMM.pdf` | 決算報告書、貸借対照表、損益計算書 |
| `5002_総勘定元帳_YYMM.pdf` | 総勘定元帳 |
| `5003_補助元帳_YYMM.pdf` | 補助元帳 |
| `5004_残高試算表_YYMM.pdf` | 残高試算表 |
| `5005_仕訳帳_YYMM.pdf` | 仕訳帳 |

### 固定資産関連（6000番台）✨ v2.1新対応
| ファイル名 | 判定キーワード |
|------------|----------------|
| `6001_固定資産台帳_YYMM.pdf` | 固定資産台帳 |
| `6002_一括償却資産明細表_YYMM.pdf` | 一括償却資産明細表、一括償却明細表、一括償却 |
| `6003_少額減価償却資産明細表_YYMM.pdf` | 少額減価償却資産明細表、少額減価償却、少額 |

### 税区分関連（7000番台）
| ファイル名 | 判定キーワード |
|------------|----------------|
| `7001_税区分集計表_YYMM.pdf` | 勘定科目別税区分集計表、税区分集計表 |

## 🔧 使い方

### 1. ファイル選択・設定タブ 📁
#### ファイル選択
- **「PDFファイルを選択」ボタン**: 個別ファイル選択
- **「フォルダを選択」ボタン**: フォルダ内PDF一括選択  
- **「クリア」ボタン**: 選択ファイルリストクリア
- **ドラッグ&ドロップ** ✨ NEW: ファイルリストボックスに直接PDFをドロップ

#### 自治体情報入力（任意）
- **セット1〜5**: 最大5つの自治体を入力
- **東京都制約**: 東京都は必ずセット1に入力
- **東京都の場合**: 市町村欄は自動的に無効化（入力不要）
- **その他都道府県**: 市町村名の入力が必要

#### 年月入力（任意）
- **YYMM形式**: 4桁で入力（例：2508 = 2025年8月）
- **自動抽出**: 空欄の場合、PDFから年月を自動検出

#### 処理実行
- **「処理実行」ボタン**: メイン処理開始
- **プログレスバー**: 処理進行状況を表示

### 2. 処理結果タブ 📊
#### 結果一覧表示
- **元ファイル名**: 処理前のファイル名
- **新ファイル名**: リネーム後のファイル名
- **書類種別**: 判定された書類の種類
- **都道府県**: 検出または入力された都道府県
- **市町村**: 検出または入力された市町村
- **状態**: 成功/要確認/エラーの処理結果

#### 色分け表示
- **🟢 緑色**: 成功（正常に処理完了）
- **🟡 黄色**: 要確認（判定に曖昧さあり）
- **🔴 赤色**: エラー（処理失敗）

#### アクション
- **「結果保存」ボタン**: 処理結果をCSVファイルで保存
- **「ファイルリネーム実行」ボタン**: 実際のファイルリネーム実行

### 3. 開発者ログタブ 🔧 ✨ v2.1強化
#### 詳細ログ表示
- **処理進行状況**: ファイル毎の詳細な処理ステップ
- **抽出テキスト例** ✨ NEW: PDFから抽出したテキストの一部表示
- **マッチキーワード** ✨ NEW: 判定に使用されたキーワード表示
- **自動抽出結果**: 都道府県、市町村、年月の自動検出結果
- **エラー詳細**: 問題が発生した場合の詳細情報

#### ログ管理
- **「ログクリア」ボタン**: 表示中のログをクリア
- **自動スクロール**: 新しいログエントリに自動スクロール

## 🎯 連番処理の詳細

### 東京都制約
- **必須条件**: 東京都が入力されている場合は必ずセット1に配置
- **エラー表示**: 他の位置にある場合はバリデーションエラー
- **市町村不要**: 東京都の場合、市町村欄は自動的に空欄扱い

### 連番規則
- **入力順序**: 実際に入力された順番通りに連番を付与
- **都道府県**: 1001 → 1011 → 1021 → 1031 → 1041
- **市町村申告書**: 2001 → 2011 → 2021 → 2031 → 2041
- **市町村受信通知**: 2003 → 2013 → 2023 → 2033 → 2043

### 柔軟対応
- **空欄対応**: セット1が空でも他のセットに入力がある場合は正常処理
- **部分入力**: 東京都のみ、単一県市のみの入力も可能

## 🔍 判定機能の詳細

### v2.1での改善点 ✨

#### 2001番台（市町村申告書）判定強化
**追加キーワード**:
- 市役所
- 市税事務所  
- 町役場
- 村役場
- 法人市町村民税
- 法人市民税
- 市町村民税
- 市民税

#### 6002番台（一括償却資産明細表）新対応
**判定キーワード**:
- 一括償却資産明細表
- 一括償却資産明細
- 一括償却明細表
- 一括償却

#### 6003番台（少額減価償却資産明細表）新対応
**判定キーワード**:
- 少額減価償却資産明細表
- 少額減価償却資産明細
- 少額減価償却明細表
- 少額減価償却
- 少額

### デバッグ機能強化 ✨
- **抽出テキスト表示**: PDFから抽出したテキストの最初の200文字を表示
- **マッチキーワード表示**: 判定に使用されたキーワードを具体的に表示
- **判定過程の可視化**: どのパターンがマッチしたかを詳細ログで確認可能

## ⚙️ 技術仕様

### 対応ファイル形式
- **PDF**：テキストPDF、スキャンPDF（OCR対応）

### OCRエンジン
- **Tesseract OCR**：日本語対応
- **自動インストール検出**：複数パスを自動検索
- **フォールバック処理**：OCR失敗時の代替処理

### UI技術
- **Tkinter**: Python標準GUIライブラリ
- **ttk**: モダンなウィジェット
- **タブノートブック**: 機能別タブ分離

### 依存ライブラリ
```
PyPDF2==3.0.1       # PDF読み取り
PyMuPDF==1.23.8     # 高度なPDF処理・OCR
pytesseract==0.3.10 # OCRエンジン
Pillow==10.1.0      # 画像処理
pyinstaller==6.15.0 # exe化
```

## 🐛 トラブルシューティング

### OCR機能が動作しない
1. **Tesseract OCRのインストール**
   - Windows: https://github.com/UB-Mannheim/tesseract/wiki
   - 日本語パッケージを含めてインストール

### ファイルが認識されない
1. **開発者ログタブで確認** ✨ NEW
   - 抽出テキスト例を確認
   - 判定キーワードとの照合結果を確認
2. **判定パターンの確認**
   - v2.1で追加されたキーワードパターンを確認

### ドラッグ&ドロップが動作しない ✨ NEW
1. **tkinterdndライブラリの確認**
   - 利用可能な場合は自動的に有効化
2. **代替手段**
   - 「PDFファイルを選択」ボタンを使用

### 2001番台が認識されない
1. **v2.1改善点を確認** ✨ NEW
   - 市役所、市税事務所等のキーワードを追加
   - より幅広い市町村申告書を認識

## 📄 ライセンス

MIT License

## 🔄 更新履歴

### v2.1 (2025-08-19) ✨ 最新版
**🆕 新機能**
- タブ形式UI実装（📁設定 📊結果 🔧ログ）
- ドラッグ&ドロップ対応
- 自動タブ切り替え機能

**🔧 改善**
- 2001番台判定パターン強化（市役所、市税事務所等追加）
- 6002/6003番台固定資産書類対応
- デバッグ機能大幅強化（抽出テキスト表示、マッチキーワード表示）

**🎨 UI/UX改善**
- スクロール可能な設定エリア
- 処理結果の色分け表示
- エラー情報の視認性向上

### v2.0 (2025-08-18)
- OCR機能対応
- 複数自治体対応
- GUI改善

### v1.0 (2025-08-17)
- 基本的なPDFリネーム機能

## 📞 サポート

### バグレポート・機能要望
- **Issues**: [GitHub Issues](https://github.com/Ezark213/tax-doc-renamer/issues)
- **ログファイル**: `%USERPROFILE%\TaxDocumentRenamer\tax_document_renamer.log`

### 使い方サポート
- **ドキュメント**: 本README
- **開発者ログタブ**: 詳細なデバッグ情報を確認